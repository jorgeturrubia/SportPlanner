<div class="min-h-screen flex flex-col bg-background">

  <!-- Navbar -->
  <app-navbar></app-navbar>

  <!-- Main Content -->
  <main class="flex-1 py-20 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">

      <!-- Loading State -->
      <div *ngIf="loading()" class="flex justify-center items-center h-64">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-green-600"></div>
      </div>

      <!-- Error State -->
      <div *ngIf="error() && !loading()" class="bg-destructive/10 border border-destructive/20 rounded-2xl p-6 mb-8">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <ng-icon name="heroExclamationTriangle" class="w-6 h-6 text-destructive mr-3"></ng-icon>
            <p class="text-sm text-destructive">{{ error() }}</p>
          </div>
          <button
            (click)="retry()"
            class="text-destructive hover:text-destructive/80 text-sm font-medium underline"
          >
            Reintentar
          </button>
        </div>
      </div>

      <!-- Content -->
      <div *ngIf="!loading() && !error()">

        <!-- User already has active subscription -->
        <div *ngIf="hasActiveSubscription()" class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-2xl p-8 mb-12">
          <div class="flex items-center">
            <ng-icon name="heroCheckCircle" class="w-10 h-10 text-green-600 mr-4"></ng-icon>
            <div class="flex-1">
              <h3 class="text-xl font-semibold text-green-800 dark:text-green-200 mb-2">¡Ya tienes una suscripción activa!</h3>
              <p class="text-green-700 dark:text-green-300">
                Tu suscripción {{ activeSubscription()?.subscriptionName }} para {{ getSportName(activeSubscription()?.sport!) }} está activa.
              </p>
            </div>
            <a
              routerLink="/dashboard"
              class="bg-green-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-green-700 transition-colors duration-200 shadow-lg hover:shadow-xl"
            >
              Ir al Dashboard
            </a>
          </div>
        </div>

        <!-- Page Header -->
        <div class="text-center mb-16">
          <h1 class="text-4xl md:text-6xl font-bold text-foreground mb-6">
            Elige tu <span class="text-primary-green-600">Plan Perfecto</span>
          </h1>
          <p class="text-xl text-muted-foreground max-w-3xl mx-auto leading-relaxed">
            Selecciona el plan que mejor se adapte a tus necesidades y elige tu deporte favorito para comenzar
          </p>
        </div>

        <!-- Subscription Plans -->
        <div class="mb-16">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            @for (subscription of availableSubscriptions(); track subscription.id) {
              <div
                (click)="selectSubscription(subscription)"
                class="relative bg-card p-8 rounded-3xl shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer border-2 hover:scale-105"
                [class.ring-4]="isSelectedSubscription(subscription)"
                [class.ring-primary-green-200]="isSelectedSubscription(subscription)"
                [class.border-primary-green-200]="isSelectedSubscription(subscription)"
                [class.border-border]="!isSelectedSubscription(subscription)"
              >

                <!-- Popular Badge -->
                @if (getPopularBadge(subscription)) {
                  <div class="absolute -top-4 left-1/2 transform -translate-x-1/2">
                    <div class="bg-primary-green-600 text-white px-4 py-2 rounded-full text-sm font-medium shadow-lg">
                      {{ getPopularBadge(subscription) }}
                    </div>
                  </div>
                }

                <!-- Selected Indicator -->
                @if (isSelectedSubscription(subscription)) {
                  <div class="absolute top-4 right-4">
                    <ng-icon name="heroCheckCircle" class="w-6 h-6 text-primary-green-600"></ng-icon>
                  </div>
                }

                <div class="text-center">
                  <h3 class="text-2xl font-bold text-foreground mb-2">{{ subscription.name }}</h3>
                  <p class="text-muted-foreground mb-8">{{ subscription.description }}</p>

                  <div class="mb-8">
                    <span class="text-5xl font-bold text-primary-green-600">{{ getSubscriptionPrice(subscription) }}</span>
                    @if (subscription.price > 0) {
                      <span class="text-muted-foreground text-lg">/mes</span>
                    }
                  </div>

                  <ul class="space-y-4 mb-8 text-left">
                    @for (feature of getSubscriptionFeatures(subscription); track feature) {
                      <li class="flex items-center">
                        <ng-icon name="heroCheck" class="w-5 h-5 text-primary-green-600 mr-3 flex-shrink-0"></ng-icon>
                        <span class="text-muted-foreground">{{ feature }}</span>
                      </li>
                    }
                  </ul>

                  <button
                    class="w-full py-4 px-6 rounded-xl font-semibold transition-all duration-300"
                    [class]="isSelectedSubscription(subscription)
                      ? 'bg-primary-green-600 text-white shadow-lg'
                      : 'bg-secondary text-secondary-foreground hover:bg-primary-green-600 hover:text-white'"
                  >
                    {{ isSelectedSubscription(subscription) ? 'Seleccionado' : 'Seleccionar Plan' }}
                  </button>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Sport Selection -->
        <div *ngIf="selectedSubscription()" class="bg-card rounded-3xl p-8 shadow-lg border border-border">
          <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-foreground mb-4">Selecciona tu Deporte</h2>
            <p class="text-muted-foreground">Elige el deporte principal para el que usarás SportPlanner</p>
          </div>

          <div class="max-w-md mx-auto">
            <label class="block text-sm font-medium text-foreground mb-3">Deporte Principal</label>
            <select
              [(ngModel)]="selectedSport"
              (ngModelChange)="onSportChange($event)"
              class="w-full px-4 py-3 bg-background border border-border rounded-xl focus:ring-2 focus:ring-primary-green-200 focus:border-primary-green-400 transition-colors duration-200"
            >
              <option [ngValue]="null" disabled>Selecciona un deporte...</option>
              @for (sportType of sportTypes(); track sportType.sportType) {
                <option [ngValue]="sportType.sportType" [selected]="isSelectedSport(sportType.sportType)">
                  {{ sportType.name }}
                </option>
              }
            </select>

            @if (selectedSport()) {
              <div class="mt-4 p-4 bg-muted rounded-xl">
                <div class="flex items-center">
                  <div class="w-12 h-12 bg-primary-green-100 dark:bg-primary-green-900/20 rounded-full flex items-center justify-center mr-4">
                    <ng-icon name="heroTrophy" class="w-6 h-6 text-primary-green-600"></ng-icon>
                  </div>
                  <div>
                    <h4 class="font-semibold text-foreground">{{ getSportName(selectedSport()!) }}</h4>
                    <p class="text-sm text-muted-foreground">{{ getSportDescription(selectedSport()!) }}</p>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Action Button -->
        <div *ngIf="canProceed()" class="text-center mt-12">
          <button
            (click)="createSubscription()"
            [disabled]="loading()"
            class="bg-primary-green-600 text-white px-12 py-4 rounded-2xl text-lg font-semibold hover:bg-primary-green-700 focus:outline-none focus:ring-4 focus:ring-primary-green-300 transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
          >
            <ng-icon *ngIf="loading()" name="heroArrowPath" class="animate-spin w-5 h-5 mr-3"></ng-icon>
            <ng-icon *ngIf="!loading()" name="heroRocketLaunch" class="w-5 h-5 mr-3"></ng-icon>
            {{ loading() ? 'Creando Suscripción...' : 'Comenzar Mi Aventura Deportiva' }}
          </button>

          <p class="text-sm text-muted-foreground mt-4">
            Al continuar, aceptas nuestros términos de servicio y política de privacidad
          </p>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <app-footer></app-footer>
</div>

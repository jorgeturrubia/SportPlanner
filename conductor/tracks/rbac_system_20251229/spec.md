# Specification: Role-Based Access Control (RBAC) System

## 1. Overview
We need to implement a robust Role-Based Access Control (RBAC) system to manage user permissions and access levels. For the MVP, we will distinguish between the **`AdminOwner`** (Platform SuperAdmin) and the **`Coach`** (Standard User/Entrenador). Future roles like `SportDirector` or `Club` should be anticipated. The system will leverage Supabase Auth Metadata to store and validate roles via JWT claims, ensuring efficient access control without constant database lookups.

## 2. Functional Requirements

### 2.1. Role Definitions
- Define a centralized `UserRole` enumeration/constant list:
    - `AdminOwner`: Platform creator/superadmin. Full access to everything, including creating "System" content (`IsSystem = true`).
    - `Coach`: Standard subscriber. Can manage their own private content and view System content.
    - `NoRole/Guest`: A user who has registered but has **not** purchased a subscription yet.

### 2.2. Infrastructure & Claims
- **Storage:** Store the user's role in Supabase `app_metadata` under the key `role`.
- **JWT Injection:** Ensure this `role` claim is present in the JWT token generated by Supabase.
- **Backend Extraction:** Update the .NET Backend Authentication/Authorization middleware to:
    1. Read the `role` claim from the incoming JWT.
    2. Expose it easily to Controllers/Services (e.g., via `User.IsInRole("AdminOwner")` or a custom `ICurrentUserService`).

### 2.3. Role Assignment Logic
- **Registration:** New users start with `NoRole` (or empty).
- **Subscription Integration:**
    - When a user purchases a subscription (or a subscription is created in the DB):
    - The system must determine the license type (e.g., "Coach License").
    - **Action:** Automatically update the user's `app_metadata` in Supabase to reflect the new role (`Coach`).
    - **Constraint:** If a user has no active subscription/role, the frontend should force a redirect to the Subscription/Pricing page.
- **Admin Assignment:** The `AdminOwner` role is assigned manually (via script or direct Supabase dashboard edit) to the platform owner.

### 2.4. Authorization Implementation
- **Global Policy:** Replace hardcoded Admin ID checks (like `var adminId = "..."`) with robust Role checks.
- **Example:** In `SportConceptsController`:
    - `Create`: If `User.Role == AdminOwner` -> `IsSystem = true`. Else `IsSystem = false`.
    - `Delete`: Only `AdminOwner` can delete `IsSystem = true` items.

## 3. Non-Functional Requirements
- **Security:** Role updates must be performed by a secure backend process (Service Role in Supabase), never by the client-side.
- **Extensibility:** The system must easily accept new roles (`Club`, `Director`) in the future without major refactoring.

## 4. Acceptance Criteria
- [ ] A `UserRole` enum/constant exists in the backend.
- [ ] Middleware correctly extracts the role from the JWT and makes it available to the application.
- [ ] Hardcoded Admin ID checks are replaced with `User.IsInRole(UserRole.AdminOwner)`.
- [ ] A mechanism (Service/Method) exists to update a user's role in Supabase `app_metadata`.
- [ ] "No Subscription" users are identified (Role is null/empty) and can be restricted.

<div class="h-full flex flex-col bg-[#121212] text-neutral-200 overflow-hidden font-sans">

    <!-- Top Bar: Tuner & Controls -->
    <div class="bg-neutral-900 border-b border-neutral-800 p-1 shrink-0 shadow-lg z-30 relative">
        <div class="w-full flex flex-col md:flex-row items-center justify-between gap-3">

            <!-- Team Selector -->
            <div class="w-full md:w-64" *ngIf="!embedded">
                <label class="block text-[9px] uppercase tracking-widest text-[#CCFF00] font-bold mb-1">Equipo</label>
                <div class="relative">
                    <select [(ngModel)]="selectedTeamId" (change)="onTeamChange()"
                        class="w-full bg-neutral-800 text-white text-xs rounded border border-neutral-700 p-1.5 focus:ring-2 focus:ring-[#CCFF00] focus:border-[#CCFF00] outline-none appearance-none cursor-pointer">
                        <option [ngValue]="null">Selecciona equipo...</option>
                        <option *ngFor="let team of teams" [ngValue]="team.id">{{ team.name }}
                            ({{team.teamCategory?.name}})</option>
                    </select>
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-neutral-400">
                        <span class="material-icons">expand_more</span>
                    </div>
                </div>
            </div>

            <!-- Planning Template Tuner -->
            <div class="flex-1 w-full" *ngIf="response">
                <app-template-tuner [templates]="templates" [activeTemplateId]="selectedTemplateId"
                    [teamCategoryName]="response.team.teamCategory?.name || ''"
                    [defaultTemplateName]="defaultTemplateName" (templateChange)="onTemplateChange($event)"
                    (createConcept)="openCreateConceptModal()">
                </app-template-tuner>
            </div>

        </div>
    </div>

    <!-- Main Content: Two Column Layout -->
    <div class="flex-1 overflow-hidden relative bg-neutral-900" *ngIf="response">
        <div class="h-full grid grid-cols-1 md:grid-cols-2 gap-4 p-4">

            <!-- LEFT COLUMN: Selected Concepts (Tu Planificación) -->
            <div class="flex flex-col h-full overflow-hidden bg-neutral-800/30 rounded-lg border border-[#CCFF00]/30">
                <div class="p-3 border-b border-neutral-700 bg-neutral-800/50 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="material-icons text-[#CCFF00]">checklist</span>
                        <h3 class="text-sm font-bold text-[#CCFF00] uppercase tracking-wider">Tu Planificación</h3>
                    </div>
                    <span class="text-xs text-neutral-400 font-mono">{{ selectedConcepts.length }} conceptos</span>
                </div>

                <div class="flex-1 overflow-y-auto custom-scrollbar p-2"
                    cdkDropList
                    id="selected-list"
                    [cdkDropListData]="selectedConcepts"
                    [cdkDropListConnectedTo]="['available-list']"
                    (cdkDropListDropped)="drop($event)">

                    <!-- Empty State -->
                    <div *ngIf="selectedConcepts.length === 0" class="h-full flex flex-col items-center justify-center text-center p-6">
                        <span class="material-icons text-4xl text-neutral-600 mb-3">drag_indicator</span>
                        <p class="text-neutral-500 text-sm">Arrastra conceptos aquí desde la biblioteca</p>
                        <p class="text-neutral-600 text-xs mt-1">o haz clic en el botón + de cada concepto</p>
                    </div>

                    <!-- Selected Concepts Grouped by Category -->
                    <div *ngFor="let group of selectedByCategory" class="mb-3">
                        <!-- Category Header -->
                        <div class="text-[10px] font-bold text-[#CCFF00] uppercase tracking-wider mb-1.5 px-1 flex items-center gap-2 sticky top-0 bg-neutral-800/90 py-1 rounded">
                            <span class="w-2 h-2 rounded-full bg-[#CCFF00]"></span>
                            {{ group.category }}
                            <span class="text-neutral-500 font-mono">({{ group.concepts.length }})</span>
                        </div>
                        
                        <!-- Concepts in Category -->
                        <div *ngFor="let conceptWrapper of group.concepts" cdkDrag [cdkDragData]="conceptWrapper"
                            class="mb-1 select-none cursor-grab active:cursor-grabbing">
                            
                            <div class="relative bg-neutral-800 border border-[#CCFF00]/40 rounded shadow overflow-hidden group hover:border-[#CCFF00] transition-all">
                                <!-- Active Indicator -->
                                <div class="absolute left-0 top-0 bottom-0 w-1 bg-[#CCFF00]"></div>
                                
                                <div class="p-2 ml-1 flex items-center gap-2">
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-medium text-xs text-white leading-tight truncate">
                                            {{ conceptWrapper.concept.name }}
                                        </h4>
                                    </div>
                                    
                                    <div class="flex items-center gap-1 shrink-0">
                                        <span class="text-[9px] font-mono text-[#CCFF00] bg-[#CCFF00]/10 px-1 py-0.5 rounded">
                                            L{{ conceptWrapper.concept.developmentLevel }}
                                        </span>
                                        <button type="button" 
                                            (click)="moveToAvailable(conceptWrapper)"
                                            class="text-neutral-500 hover:text-red-500 transition-colors"
                                            title="Quitar de planificación">
                                            <span class="material-icons text-[14px]">close</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Available Concepts (Biblioteca) -->
            <div class="flex flex-col h-full overflow-hidden bg-neutral-800/20 rounded-lg border border-neutral-700">
                <div class="p-3 border-b border-neutral-700 bg-neutral-800/50 flex flex-col gap-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-neutral-400">library_books</span>
                            <h3 class="text-sm font-bold text-neutral-300 uppercase tracking-wider">Biblioteca</h3>
                        </div>
                        <span class="text-xs text-neutral-500 font-mono">{{ availableConcepts.length }} disponibles</span>
                    </div>

                    <!-- Search Input -->
                    <div class="relative">
                        <span class="material-icons absolute left-2 top-1/2 -translate-y-1/2 text-neutral-500 text-sm">search</span>
                        <input type="text" [(ngModel)]="searchQuery"
                            placeholder="Buscar concepto..."
                            class="w-full bg-neutral-900 border border-neutral-700 rounded-md py-1.5 pl-8 pr-3 text-xs text-white placeholder-neutral-500 focus:outline-none focus:border-[#CCFF00] transition-colors">
                    </div>

                    <!-- Category Chips -->
                    <div class="flex items-center gap-2 overflow-x-auto custom-scrollbar-horizontal pb-1">
                        <button type="button" 
                            (click)="setCategoryFilter('all')"
                            [class]="'whitespace-nowrap px-2 py-1 rounded text-[10px] font-bold uppercase transition-all border ' + 
                            (selectedCategoryFilter === 'all' 
                                ? 'bg-[#CCFF00] text-black border-[#CCFF00]' 
                                : 'bg-transparent text-neutral-400 border-neutral-700 hover:border-neutral-500')">
                            Todos
                        </button>
                        <button *ngFor="let cat of filteredCategories" type="button" 
                            (click)="setCategoryFilter(cat)"
                            [class]="'whitespace-nowrap px-2 py-1 rounded text-[10px] font-bold uppercase transition-all border ' + 
                            (selectedCategoryFilter === cat
                                ? 'bg-[#CCFF00] text-black border-[#CCFF00]' 
                                : 'bg-transparent text-neutral-400 border-neutral-700 hover:border-neutral-500')">
                            {{ cat }}
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto custom-scrollbar p-2"
                    cdkDropList
                    id="available-list"
                    [cdkDropListData]="availableConcepts"
                    [cdkDropListConnectedTo]="['selected-list']"
                    (cdkDropListDropped)="drop($event)">

                    <!-- Empty State -->
                    <div *ngIf="availableByCategory.length === 0" class="h-full flex flex-col items-center justify-center text-center p-6">
                        <span class="material-icons text-4xl text-neutral-600 mb-3">folder_open</span>
                        <p class="text-neutral-500 text-sm">No se encontraron conceptos</p>
                        <button type="button" (click)="openCreateConceptModal()" 
                            class="mt-3 px-4 py-2 bg-[#CCFF00]/10 text-[#CCFF00] rounded text-xs font-bold uppercase hover:bg-[#CCFF00]/20 transition-colors">
                            + Crear Concepto
                        </button>
                    </div>

                    <!-- Available Concepts Grouped by Category -->
                    <div *ngFor="let group of availableByCategory" class="mb-3">
                        <!-- Category Header (Clickable for collapse) -->
                        <div (click)="toggleCategory(group.category)" 
                            class="text-[10px] font-bold text-neutral-500 uppercase tracking-wider mb-1 px-1 flex items-center gap-2 cursor-pointer hover:text-neutral-300 select-none">
                            <span class="material-icons text-[14px] transition-transform duration-200"
                                [class.rotate-180]="isCategoryCollapsed(group.category)">expand_more</span>
                            {{ group.category }}
                        </div>
                        
                        <!-- Concepts in Category -->
                        <div *ngIf="!isCategoryCollapsed(group.category)" class="animate-in fade-in slide-in-from-top-1 duration-200">
                            <div *ngFor="let conceptWrapper of group.concepts" cdkDrag [cdkDragData]="conceptWrapper"
                                class="mb-1 select-none cursor-grab active:cursor-grabbing">
                            
                            <div class="group relative bg-neutral-800/60 hover:bg-neutral-800 border border-transparent hover:border-neutral-600 rounded transition-all">
                                <div class="p-2 flex items-center gap-2">
                                    <!-- Quick Add Button -->
                                    <button type="button" 
                                        (click)="moveToSelected(conceptWrapper)"
                                        class="text-neutral-600 hover:text-[#CCFF00] transition-colors shrink-0">
                                        <span class="material-icons text-[18px]">add_circle_outline</span>
                                    </button>
                                    
                                    <div class="flex-1 min-w-0">
                                        <h4 class="text-xs font-medium text-neutral-300 group-hover:text-white truncate">
                                            {{ conceptWrapper.concept.name }}
                                        </h4>
                                    </div>
                                    
                                    <span class="text-[9px] font-mono text-neutral-500 shrink-0">
                                        L{{ conceptWrapper.concept.developmentLevel }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="absolute inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <div class="w-8 h-8 border-4 border-[#CCFF00] border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-neutral-400 animate-pulse">Cargando conceptos...</p>
        </div>
    </div>

    <!-- Empty State: No Team Selected -->
    <div *ngIf="!response && !loading" class="flex-1 flex flex-col items-center justify-center opacity-30">
        <span class="material-icons text-8xl text-neutral-600 mb-4">sports_basketball</span>
        <p class="text-xl text-neutral-500">Selecciona un equipo para ver su planificación</p>
    </div>

    <!-- CREATE CONCEPT MODAL -->
    <div *ngIf="showCreateModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm animate-fadeIn p-4 md:p-10">
        <div class="w-full h-full max-w-6xl">
            <app-concept-creator 
                (close)="closeCreateConceptModal()" 
                (conceptCreated)="handleConceptCreated($event)">
            </app-concept-creator>
        </div>
    </div>
</div>
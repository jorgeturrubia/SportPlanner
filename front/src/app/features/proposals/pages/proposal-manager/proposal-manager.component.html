<div class="h-full flex flex-col bg-[#121212] text-neutral-200 overflow-hidden font-sans">

    <!-- Top Bar: Tuner & Controls -->
    <div class="bg-neutral-900 border-b border-neutral-800 p-1 shrink-0 shadow-lg z-30 relative">
        <div class="w-full flex flex-col md:flex-row items-center justify-between gap-3">

            <!-- Team Selector -->
            <div class="w-full md:w-64" *ngIf="!embedded">
                <label class="block text-[9px] uppercase tracking-widest text-[#CCFF00] font-bold mb-1">Equipo</label>
                <div class="relative">
                    <select [(ngModel)]="selectedTeamId" (change)="onTeamChange()"
                        class="w-full bg-neutral-800 text-white text-xs rounded border border-neutral-700 p-1.5 focus:ring-2 focus:ring-[#CCFF00] focus:border-[#CCFF00] outline-none appearance-none cursor-pointer">
                        <option [ngValue]="null">Selecciona equipo...</option>
                        <option *ngFor="let team of teams" [ngValue]="team.id">{{ team.name }}
                            ({{team.teamCategory?.name}})</option>
                    </select>
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-neutral-400">
                        <span class="material-icons">expand_more</span>
                    </div>
                </div>
            </div>

            <!-- Planning Template Tuner -->
            <div class="flex-1 w-full" *ngIf="response">
                <app-template-tuner [templates]="templates" [activeTemplateId]="selectedTemplateId"
                    [teamCategoryName]="response.team.teamCategory?.name || ''"
                    [defaultTemplateName]="defaultTemplateName" (templateChange)="onTemplateChange($event)"
                    (createConcept)="openCreateConceptModal()">
                </app-template-tuner>
            </div>

        </div>
    </div>

    <!-- Main Content: Two Column Layout -->
    <div class="flex-1 overflow-hidden relative bg-neutral-900" *ngIf="response">
        <div class="h-full grid grid-cols-1 md:grid-cols-2 gap-4 p-4">

            <!-- LEFT COLUMN: Selected Concepts (Tu Planificación) -->
            <div class="flex flex-col h-full overflow-hidden bg-neutral-800/30 rounded-lg border border-[#CCFF00]/30 shadow-lg">
                <div class="p-3 border-b border-neutral-700 bg-neutral-800/50 flex items-center justify-between backdrop-blur-sm">
                    <div class="flex items-center gap-2">
                        <span class="material-icons text-[#CCFF00]">checklist</span>
                        <h3 class="text-sm font-bold text-[#CCFF00] uppercase tracking-wider">Tu Planificación</h3>
                    </div>
                    <span class="text-xs text-neutral-400 font-mono">{{ selectedConcepts.length }} conceptos</span>
                </div>

                <div class="flex-1 overflow-y-auto custom-scrollbar p-2" cdkDropList id="selected-list"
                    [cdkDropListData]="selectedConcepts" [cdkDropListConnectedTo]="['available-list']"
                    (cdkDropListDropped)="drop($event)">

                    <!-- Empty State -->
                    <div *ngIf="selectedConcepts.length === 0"
                        class="h-full flex flex-col items-center justify-center text-center p-6 opacity-60">
                        <span class="material-icons text-5xl text-neutral-600 mb-3">drag_indicator</span>
                        <p class="text-neutral-500 text-sm font-medium">Lista vacía</p>
                        <p class="text-neutral-600 text-xs mt-1">Arrastra conceptos aquí</p>
                    </div>

                    <!-- Empty State -->
                    <div *ngIf="selectedTree.length === 0"
                        class="h-full flex flex-col items-center justify-center text-center p-6 opacity-60">
                        <span class="material-icons text-5xl text-neutral-600 mb-3">drag_indicator</span>
                        <p class="text-neutral-500 text-sm font-medium">Lista vacía</p>
                        <p class="text-neutral-600 text-xs mt-1">Arrastra conceptos aquí</p>
                    </div>

                    <!-- Selected Concepts Tree -->
                    <ng-container *ngFor="let node of selectedTree">
                        <ng-container *ngTemplateOutlet="categoryNodeTemplate; context: { $implicit: node, level: 0, isSelectionMode: true }"></ng-container>
                    </ng-container>
                </div>
            </div>

            <!-- RIGHT COLUMN: Available Concepts (Biblioteca) -->
            <div class="flex flex-col h-full overflow-hidden bg-neutral-800/20 rounded-lg border border-neutral-700 shadow-lg">
                <!-- Header: Navigation & Search -->
                <div class="p-3 border-b border-neutral-700 bg-neutral-800/50 flex flex-col gap-2 backdrop-blur-sm shrink-0">
                    
                    <div class="flex items-center justify-between gap-4">
                        <!-- Search Input -->
                       <div class="relative group flex-1">
                           <span class="material-icons absolute left-2 top-1/2 -translate-y-1/2 text-neutral-500 text-sm group-focus-within:text-[#CCFF00] transition-colors">search</span>
                           <input type="text" [(ngModel)]="searchQuery" placeholder="Buscar concepto..."
                               class="w-full bg-neutral-900 border border-neutral-700 rounded-md py-1.5 pl-8 pr-3 text-xs text-white placeholder-neutral-500 focus:outline-none focus:border-[#CCFF00] focus:ring-1 focus:ring-[#CCFF00]/20 transition-all">
                            <button type="button" *ngIf="searchQuery" (click)="searchQuery = ''" class="absolute right-2 top-1/2 -translate-y-1/2 text-neutral-500 hover:text-white">
                               <span class="material-icons text-[14px]">close</span>
                           </button>
                       </div>
                       
                       <button type="button" (click)="openCreateConceptModal()" 
                           class="px-3 py-1.5 bg-[#CCFF00]/10 text-[#CCFF00] rounded text-[10px] font-bold uppercase hover:bg-[#CCFF00]/20 transition-colors border border-[#CCFF00]/20 flex items-center gap-1 shrink-0">
                           <span class="material-icons text-[14px]">add</span>
                           Nuevo
                       </button>
                   </div>
                    
                    <!-- Breadcrumbs (Traceability) -->
                    <div class="flex items-center gap-1 flex-wrap text-xs text-neutral-400 font-mono pl-1">
                         <span class="material-icons text-[14px] text-neutral-500">home</span>
                         
                         <ng-container *ngFor="let crumb of breadcrumbs; let last = last">
                             <span *ngIf="crumb.id !== null" class="material-icons text-[12px] text-neutral-600 mx-0.5">chevron_right</span>
                             
                             <button type="button" 
                                (click)="setCurrentCategory(crumb.id)"
                                class="hover:text-white transition-colors"
                                [class.text-[#CCFF00]]="last"
                                [class.font-bold]="last"
                                [class.underline]="!last"
                                [disabled]="last">
                                {{ crumb.name }}
                             </button>
                         </ng-container>
                    </div>

                    <!-- Navigation Buttons (Drill Down) -->
                    <div class="flex items-center gap-2 overflow-x-auto custom-scrollbar-horizontal pb-1 mt-1 min-h-[30px]" *ngIf="navigationButtons.length > 0">
                        <button type="button" *ngFor="let cat of navigationButtons" 
                             (click)="setCurrentCategory(cat.id)"
                             class="whitespace-nowrap px-3 py-1.5 rounded-full text-[10px] font-bold uppercase transition-all border shrink-0 bg-neutral-900 border-neutral-700 text-neutral-400 hover:border-neutral-500 hover:text-white">
                             {{ cat.name }}
                        </button>
                    </div>
                </div>

                <!-- Content: Nested Tree List -->
                <div class="flex-1 overflow-y-auto custom-scrollbar p-2 bg-neutral-900/30"
                    cdkDropList id="available-list"
                    [cdkDropListData]="availableConcepts" 
                    [cdkDropListConnectedTo]="['selected-list']"
                    (cdkDropListDropped)="drop($event)">

                     <!-- Recursive Template Outlet -->
                     <ng-container *ngFor="let node of visibleTree">
                        <ng-container *ngTemplateOutlet="categoryNodeTemplate; context: { $implicit: node, level: 0 }"></ng-container>
                     </ng-container>

                     <!-- Empty State -->
                     <div *ngIf="visibleTree.length === 0" class="h-full flex flex-col items-center justify-center text-center p-6 opacity-60">
                        <span class="material-icons text-4xl text-neutral-700 mb-3">folder_open</span>
                        <p class="text-neutral-500 text-sm">Esta carpeta está vacía</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Recursive Category Node Template -->
    <ng-template #categoryNodeTemplate let-node let-level="level" let-isSelectionMode="isSelectionMode">
        <div class="mb-1">
            <!-- Category Header -->
            <div (click)="toggleCategory(node.id, isSelectionMode || false)" 
                class="flex items-center gap-2 py-1 px-2 rounded cursor-pointer select-none hover:bg-neutral-800/50 transition-colors group"
                [style.margin-left.px]="level * 12">
                
                <span class="material-icons text-[14px] transition-transform duration-200"
                      [class.rotate-90]="node.isExpanded"
                      [class.text-neutral-500]="!isSelectionMode"
                      [class.text-[#CCFF00]]="isSelectionMode">chevron_right</span>

                <span class="text-[10px] font-bold uppercase tracking-wide"
                    [class.text-neutral-400]="!isSelectionMode"
                    [class.text-[#CCFF00]]="isSelectionMode">
                    {{ node.name }}
                </span>
                
                <span class="text-[9px] text-neutral-600 font-mono ml-auto" *ngIf="node.concepts?.length">
                    {{ node.concepts?.length }}
                </span>
            </div>

            <!-- Body (Expanded if isExpanded is true) -->
            <div *ngIf="node.isExpanded">
                
                <!-- Concepts List -->
                <div class="flex flex-col gap-1 mt-1 mb-2" [style.padding-left.px]="(level + 1) * 12 + (isSelectionMode ? 4 : 8)">
                    <div *ngFor="let conceptWrapper of node.concepts" cdkDrag [cdkDragData]="conceptWrapper"
                        class="group relative rounded border transition-all cursor-grab active:cursor-grabbing select-none overflow-hidden"
                        [class.bg-neutral-800/80]="!isSelectionMode"
                        [class.hover:bg-neutral-800]="!isSelectionMode"
                        [class.border-neutral-700]="!isSelectionMode"
                        [class.hover:border-[#CCFF00]/50]="!isSelectionMode"
                        [class.bg-neutral-800]="isSelectionMode"
                        [class.border-[#CCFF00]/40]="isSelectionMode"
                        [class.hover:border-[#CCFF00]]="isSelectionMode">
                        
                        <!-- Selected Indicator -->
                        <div *ngIf="isSelectionMode" class="absolute left-0 top-0 bottom-0 w-1 bg-[#CCFF00]"></div>

                        <div (click)="isSelectionMode ? moveToAvailable(conceptWrapper) : moveToSelected(conceptWrapper)" 
                            class="p-2 flex items-center gap-2 cursor-pointer"
                            [class.ml-1]="isSelectionMode">
                            
                             <!-- Action Icon -->
                            <div class="rounded-full p-1 transition-all shrink-0"
                                [class.text-neutral-600]="!isSelectionMode"
                                [class.group-hover:text-[#CCFF00]]="!isSelectionMode"
                                [class.group-hover:bg-[#CCFF00]/10]="!isSelectionMode"
                                [class.text-neutral-500]="isSelectionMode"
                                [class.group-hover:text-red-500]="isSelectionMode"
                                [class.group-hover:bg-red-500/10]="isSelectionMode">
                                <span class="material-icons text-[16px]">{{ isSelectionMode ? 'close' : 'add' }}</span>
                            </div>

                            <div class="flex-1 min-w-0">
                                <h4 class="text-xs font-medium truncate transition-colors"
                                    [class.text-neutral-300]="!isSelectionMode"
                                    [class.group-hover:text-white]="!isSelectionMode"
                                    [class.text-white]="isSelectionMode"
                                    [class.font-bold]="isSelectionMode">
                                    {{ conceptWrapper.concept.name }}
                                </h4>
                            </div>

                            <span class="text-[9px] font-mono px-1.5 py-0.5 rounded border shrink-0"
                                [class.text-neutral-500]="!isSelectionMode"
                                [class.bg-neutral-900/50]="!isSelectionMode"
                                [class.border-neutral-700]="!isSelectionMode"
                                [class.text-[#CCFF00]]="isSelectionMode"
                                [class.bg-[#CCFF00]/10]="isSelectionMode"
                                [class.border-[#CCFF00]/10]="isSelectionMode">
                                L{{ conceptWrapper.concept.developmentLevel }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Subcategories (Recursive) -->
                <ng-container *ngFor="let subNode of node.subCategories">
                     <ng-container *ngTemplateOutlet="categoryNodeTemplate; context: { $implicit: subNode, level: level + 1, isSelectionMode: isSelectionMode }"></ng-container>
                </ng-container>
            </div>
        </div>
    </ng-template>

    <!-- Loading State -->
    <div *ngIf="loading" class="absolute inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="flex flex-col items-center p-6 bg-neutral-900 border border-neutral-800 rounded-xl shadow-2xl">
            <div class="w-8 h-8 border-4 border-[#CCFF00] border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-neutral-400 animate-pulse text-sm font-medium">Procesando planificación...</p>
        </div>
    </div>

    <!-- Empty State: No Team Selected -->
    <div *ngIf="!response && !loading" class="flex-1 flex flex-col items-center justify-center opacity-30 select-none pointer-events-none">
        <span class="material-icons text-9xl text-neutral-800 mb-4 transform -rotate-12">sports_basketball</span>
        <p class="text-2xl text-neutral-600 font-bold uppercase tracking-widest">SportPlanner</p>
    </div>

    <!-- CREATE CONCEPT MODAL -->
    <div *ngIf="showCreateModal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm animate-fadeIn p-4 md:p-10">
        <div class="w-full h-full max-w-6xl">
            <app-concept-creator (close)="closeCreateConceptModal()" (conceptCreated)="handleConceptCreated($event)">
            </app-concept-creator>
        </div>
    </div>

</div>
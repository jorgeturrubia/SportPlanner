<div class="h-full flex flex-col bg-[#0b1120] text-slate-200 overflow-hidden font-sans">

    <!-- Top Bar: Tuner & Controls -->
    <div class="bg-slate-900 border-b border-slate-700/50 p-4 shrink-0 shadow-lg z-30 relative">
        <div class="max-w-[1600px] mx-auto w-full flex flex-col md:flex-row items-center justify-between gap-6">

            <!-- Team Selector -->
            <div class="w-full md:w-64">
                <label class="block text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-1">Equipo</label>
                <div class="relative">
                    <select [(ngModel)]="selectedTeamId" (change)="onTeamChange()"
                        class="w-full bg-slate-800 text-white text-sm rounded border border-slate-700 p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none appearance-none cursor-pointer">
                        <option [ngValue]="null">Selecciona equipo...</option>
                        <option *ngFor="let team of teams" [ngValue]="team.id">{{ team.name }}
                            ({{team.teamCategory?.name}})</option>
                    </select>
                    <span
                        class="material-icons absolute right-2 top-2.5 text-slate-400 pointer-events-none text-lg">expand_more</span>
                </div>
            </div>

            <!-- Itinerary Tuner -->
            <div class="block" *ngIf="response">
                <app-itinerary-tuner [teamName]="response.team.name" [categoryName]="response.team.teamCategory?.name"
                    [currentOffset]="currentLevelOffset" (offsetChange)="onLevelOffsetChange($event)">
                </app-itinerary-tuner>
            </div>

        </div>
    </div>

    <!-- Main Content: Scrollable Area -->
    <div class="flex-1 overflow-y-auto custom-scrollbar relative" *ngIf="response && !loading">
        <div class="max-w-[1600px] mx-auto w-full pb-20">

            <!-- Central Trunk Line (Visual Spine) -->
            <div
                class="absolute left-[54%] top-0 bottom-0 w-[2px] bg-gradient-to-b from-blue-900/20 via-blue-500/10 to-blue-900/20 md:block hidden z-0">
            </div>

            <!-- SECTIONS LOOP -->
            <div *ngFor="let section of methodologicalSections" class="mb-12 relative z-10">

                <!-- Section Header (Sticky) -->
                <div
                    class="sticky top-0 z-20 bg-[#0b1120]/95 backdrop-blur border-b border-blue-500/30 px-6 py-4 mb-4 shadow-md flex items-center gap-3">
                    <div class="w-1 h-6 bg-blue-500 rounded-full"></div>
                    <h2 class="text-xl font-black uppercase tracking-widest text-white shadow-blue-glow">{{ section.name
                        }}</h2>
                    <span
                        class="text-[10px] bg-blue-500/10 text-blue-300 px-2 py-0.5 rounded border border-blue-500/20 font-mono">SECCIÓN</span>
                </div>

                <!-- CATEGORIES LOOP -->
                <div *ngFor="let category of section.categories" class="mb-8">

                    <!-- Category Header -->
                    <div class="px-6 mb-4 flex items-center gap-4">
                        <div class="h-[1px] w-8 bg-slate-700"></div>
                        <h3 class="text-sm font-bold text-blue-400 uppercase tracking-widest">{{ category.name }}</h3>
                        <div class="h-[1px] flex-1 bg-slate-700/30"></div>
                    </div>

                    <!-- SUBCATEGORIES LOOP (ROWS) -->
                    <div class="flex flex-col gap-6 px-4">
                        <div *ngFor="let row of category.subCategories"
                            class="methodology-row grid grid-cols-1 md:grid-cols-[1.2fr_0.8fr] gap-0 md:gap-12 relative group/row">

                            <!-- Row Label (Mobile Only) -->
                            <div
                                class="md:hidden text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 pl-2 border-l-2 border-slate-700">
                                {{ row.name }}</div>

                            <!-- LEFT COLUMN: ACTIVE (Main Focus) -->
                            <div class="active-column relative pr-4">
                                <!-- Row Label (Desktop Floating) -->
                                <div
                                    class="hidden md:block absolute -left-2 top-0 -translate-x-full pr-4 text-right w-48 opacity-40 group-hover/row:opacity-100 transition-opacity">
                                    <span class="text-[11px] font-bold text-blue-200 uppercase tracking-widest">{{
                                        row.name }}</span>
                                </div>

                                <div class="min-h-[80px] rounded-xl bg-slate-900/20 p-2" cdkDropList
                                    [id]="row.activeListId" [cdkDropListData]="row.activeConcepts"
                                    [cdkDropListConnectedTo]="allListIds" (cdkDropListDropped)="drop($event)">

                                    <div *ngFor="let conceptWrapper of row.activeConcepts" cdkDrag
                                        [cdkDragData]="conceptWrapper">

                                        <!-- ACTIVE CARD -->
                                        <div
                                            class="active-card relative flex flex-col p-4 mb-3 hover:translate-x-1 transition-transform cursor-move">
                                            <!-- Connection to Trunk -->
                                            <div
                                                class="absolute -right-[50px] top-1/2 h-[2px] w-[50px] bg-blue-500/30 hidden md:block">
                                            </div>
                                            <div
                                                class="absolute -right-[54px] top-1/2 w-2 h-2 bg-blue-400 rounded-full shadow-[0_0_8px_#3b82f6] hidden md:block z-10">
                                            </div>

                                            <div class="flex items-start justify-between gap-3 mb-1">
                                                <h4 class="font-bold text-sm text-white leading-tight">{{
                                                    conceptWrapper.concept.name }}</h4>
                                                <span
                                                    class="text-[10px] font-mono font-bold text-blue-200 bg-blue-600/30 border border-blue-500/30 px-1.5 py-0.5 rounded shrink-0">L{{
                                                    conceptWrapper.concept.developmentLevel }}</span>
                                            </div>
                                            <p *ngIf="conceptWrapper.concept.technicalTacticalFocus"
                                                class="text-[11px] text-blue-300/80 mb-2 font-medium">{{
                                                conceptWrapper.concept.technicalTacticalFocus }}</p>
                                            <p *ngIf="conceptWrapper.concept.description"
                                                class="text-[12px] text-slate-300 leading-snug line-clamp-3">{{
                                                conceptWrapper.concept.description }}</p>
                                        </div>
                                        <div *cdkDragPlaceholder
                                            class="h-16 bg-blue-500/5 border border-blue-500/20 border-dashed rounded-lg mb-3">
                                        </div>
                                    </div>

                                    <!-- Empty State for Active -->
                                    <div *ngIf="row.activeConcepts.length === 0"
                                        class="h-20 flex items-center justify-center border border-dashed border-slate-800 rounded-lg">
                                        <span class="text-xs text-slate-700 italic">Sin conceptos activos</span>
                                    </div>
                                </div>
                            </div>

                            <!-- RIGHT COLUMN: CONTEXT (Future & Past) -->
                            <div class="context-column flex flex-col gap-2 relative pl-4 border-l border-slate-800/50">

                                <!-- FUTURE (Top) -->
                                <div class="future-group" cdkDropList [id]="row.futureListId"
                                    [cdkDropListData]="row.futureConcepts" [cdkDropListConnectedTo]="allListIds"
                                    (cdkDropListDropped)="drop($event)">

                                    <div *ngFor="let conceptWrapper of row.futureConcepts" cdkDrag
                                        [cdkDragData]="conceptWrapper">
                                        <div
                                            class="future-card flex items-start gap-3 p-3 mb-2 rounded border border-dashed border-yellow-600/30 bg-yellow-900/5 hover:bg-yellow-900/10 cursor-move group/future transition-colors">
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between gap-2 mb-1">
                                                    <h4
                                                        class="text-xs font-bold text-yellow-100/90 group-hover/future:text-yellow-100 truncate">
                                                        {{ conceptWrapper.concept.name }}</h4>
                                                    <span
                                                        class="text-[9px] text-yellow-500/80 border border-yellow-600/30 px-1 rounded">L{{
                                                        conceptWrapper.concept.developmentLevel }}</span>
                                                </div>
                                                <p class="text-[10px] text-yellow-200/50 line-clamp-2 leading-relaxed">
                                                    {{ conceptWrapper.concept.description }}</p>
                                                <!-- <p class="text-[9px] text-yellow-600/60 mt-1 uppercase tracking-wider font-bold">Próximo Reto</p> -->
                                            </div>
                                        </div>
                                        <div *cdkDragPlaceholder
                                            class="h-8 bg-yellow-500/5 border border-yellow-500/20 border-dashed rounded mb-2">
                                        </div>
                                    </div>
                                </div>

                                <!-- PAST (Bottom) -->
                                <div class="past-group mt-auto pt-2 border-t border-slate-800/50" cdkDropList
                                    [id]="row.pastListId" [cdkDropListData]="row.pastConcepts"
                                    [cdkDropListConnectedTo]="allListIds" (cdkDropListDropped)="drop($event)">

                                    <div *ngFor="let conceptWrapper of row.pastConcepts" cdkDrag
                                        [cdkDragData]="conceptWrapper">
                                        <div
                                            class="past-card flex items-start gap-3 p-2 mb-1 rounded opacity-60 hover:opacity-100 transition-opacity cursor-move bg-slate-800/20 border border-transparent hover:border-slate-700">
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between gap-2">
                                                    <h4 class="text-xs font-medium text-slate-400 truncate">{{
                                                        conceptWrapper.concept.name }}</h4>
                                                    <span class="text-[9px] text-slate-600">L{{
                                                        conceptWrapper.concept.developmentLevel }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div *cdkDragPlaceholder
                                            class="h-6 bg-slate-700/20 border border-slate-700/50 border-dashed rounded mb-1">
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="loading" class="flex flex-col items-center justify-center h-64">
            <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-slate-400 animate-pulse">Generando itinerario metodológico...</p>
        </div>

        <!-- Empty State -->
        <div *ngIf="!response && !loading" class="flex flex-col items-center justify-center h-96 opacity-30">
            <span class="material-icons text-8xl text-slate-700 mb-4">sports_basketball</span>
            <p class="text-xl text-slate-500">Selecciona un equipo para ver su árbol metodológico</p>
        </div>
    </div>
</div>
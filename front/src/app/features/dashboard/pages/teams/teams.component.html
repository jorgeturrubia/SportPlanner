<!-- Compact Header -->
<div class="mb-4 flex justify-between items-center border-b border-dark-border pb-2">
    <div class="flex items-center gap-3">
        <h2 class="text-xl font-black text-white tracking-tight uppercase">MIS EQUIPOS</h2>
        <span class="text-gray-600 text-sm hidden sm:inline-block">|</span>
        <p class="text-gray-500 text-xs sm:text-sm hidden sm:block">Gestiona tus equipos</p>
    </div>
    <button (click)="toggleForm()" *ngIf="!showForm()"
        class="px-3 py-1.5 bg-primary text-black font-bold uppercase text-[10px] tracking-wider hover:bg-white transition-colors flex items-center gap-1 rounded-sm">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Crear Equipo
    </button>
</div>

<!-- Form Section -->
<div *ngIf="showForm()"
    class="mb-8 p-6 bg-dark-surface border border-dark-border animate-in fade-in slide-in-from-top-4 duration-300">
    <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
        <span class="w-1 h-6 bg-primary rounded-full"></span>
        {{ editingTeamId() ? 'Editar Equipo' : 'Nuevo Equipo' }}
    </h3>

    <form [formGroup]="teamForm" (ngSubmit)="onSubmit()" class="space-y-4">
        <!-- Name (Full Width) -->
        <div>
            <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">NOMBRE DEL EQUIPO</label>
            <input type="text" formControlName="name"
                class="w-full bg-dark-bg border border-dark-border p-3 rounded text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all placeholder:text-gray-600"
                placeholder="Ej: Los Invencibles FC">
        </div>

        <!-- Category & Level (2 Columns) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Team Category -->
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">CATEGORÍA</label>
                <div class="relative">
                    <select formControlName="teamCategoryId"
                        class="w-full bg-dark-bg border border-dark-border p-3 rounded appearance-none text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all cursor-pointer">
                        <option [value]="null">Selecciona una categoría</option>
                        <option *ngFor="let category of teamCategories()" [value]="category.id">
                            {{ category.name }}
                            {{ category.minAge || category.maxAge ? '(' + (category.minAge ? category.minAge + 'a' : '')
                            + (category.minAge && category.maxAge ? ' - ' : '') + (category.maxAge ? category.maxAge +
                            'a' : '') + ')' : '' }}
                        </option>
                    </select>
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m6 9 6 6 6-6" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Team Level -->
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">NIVEL
                    COMPETITIVO</label>
                <div class="relative">
                    <select formControlName="teamLevelId"
                        class="w-full bg-dark-bg border border-dark-border p-3 rounded appearance-none text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all cursor-pointer">
                        <option [value]="null">Selecciona un nivel</option>
                        <option *ngFor="let level of teamLevels()" [value]="level.id">
                            {{ level.name }}
                        </option>
                    </select>
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m6 9 6 6 6-6" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Technical & Tactical Levels (2 Columns) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Technical Proficiency Level -->
            <div class="bg-dark-bg/50 p-3 rounded border border-dark-border">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">NIVEL TÉCNICO</label>
                    <span class="text-primary font-black text-lg">{{ teamForm.get('currentTechnicalLevel')?.value
                        }}<span class="text-gray-600 text-xs font-normal">/10</span></span>
                </div>
                <input type="range" formControlName="currentTechnicalLevel" min="1" max="10" step="1"
                    class="w-full h-1.5 bg-dark-border rounded-lg appearance-none cursor-pointer accent-primary hover:accent-primary-light transition-all">
                <div class="flex justify-between text-[10px] text-gray-500 mt-1 font-medium uppercase">
                    <span>Principiante</span>
                    <span>Avanzado</span>
                </div>
            </div>

            <!-- Tactical Proficiency Level -->
            <div class="bg-dark-bg/50 p-3 rounded border border-dark-border">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">NIVEL TÁCTICO</label>
                    <span class="text-secondary font-black text-lg">{{ teamForm.get('currentTacticalLevel')?.value
                        }}<span class="text-gray-600 text-xs font-normal">/10</span></span>
                </div>
                <input type="range" formControlName="currentTacticalLevel" min="1" max="10" step="1"
                    class="w-full h-1.5 bg-dark-border rounded-lg appearance-none cursor-pointer accent-secondary hover:accent-secondary-light transition-all">
                <div class="flex justify-between text-[10px] text-gray-500 mt-1 font-medium uppercase">
                    <span>Básico</span>
                    <span>Experto</span>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex gap-3 pt-4 border-t border-dark-border mt-2">
            <button type="button" (click)="toggleForm()"
                class="flex-1 px-4 py-3 border border-gray-600 text-gray-300 font-bold uppercase tracking-wider text-sm rounded hover:bg-gray-800 hover:text-white transition-all">
                Cancelar
            </button>
            <button type="submit" [disabled]="!teamForm.valid || isLoading()"
                class="flex-[2] px-6 py-3 bg-primary text-black font-bold uppercase tracking-wider text-sm rounded shadow-[0_0_15px_rgba(34,197,94,0.3)] hover:bg-white hover:shadow-[0_0_20px_rgba(255,255,255,0.4)] transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none">
                {{ isLoading() ? 'GUARDANDO...' : (editingTeamId() ? 'ACTUALIZAR CAMBIOS' : 'CREAR EQUIPO') }}
            </button>
        </div>
    </form>
</div>

<!-- Teams Grid (Only shown when form is hidden) -->
<div *ngIf="!showForm()" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-in fade-in duration-500"
    (click)="closeMenu()">
    <div *ngFor="let team of teams()"
        class="group relative bg-dark-surface border border-dark-border hover:border-gray-500 transition-all duration-300 h-64 rounded-lg overflow-hidden shadow-lg hover:shadow-xl hover:-translate-y-1">

        <!-- Decorative top bar gradient -->
        <div
            class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary via-white to-secondary opacity-50 group-hover:opacity-100 transition-opacity">
        </div>

        <!-- Main Content (Dimmed when menu is active) -->
        <div class="p-6 h-full flex flex-col transition-all duration-300" [class.blur-sm]="activeMenuId() === team.id"
            [class.opacity-20]="activeMenuId() === team.id">

            <!-- Header with Team Name and Actions Button -->
            <div class="flex justify-between items-start mb-4">
                <!-- Team Name -->
                <div class="flex-1 mr-2 overflow-hidden">
                    <h3 class="text-xl font-black text-white tracking-tight truncate" title="{{ team.name }}">
                        {{ team.name }}
                    </h3>
                    <div class="text-xs text-secondary font-bold uppercase tracking-widest mt-0.5">
                        {{ team.activeSubscriptions?.[0]?.sport?.name || 'FÚTBOL' }}
                        <!-- Fallback/Improvement needed if sport available in team obj -->
                    </div>
                </div>

                <!-- Actions Button -->
                <button (click)="toggleMenu(team.id, $event)"
                    class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 w-8 h-8 bg-dark-bg border border-dark-border text-gray-300 rounded hover:text-white hover:border-white transition-all flex items-center justify-center flex-shrink-0 mb-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="1"></circle>
                        <circle cx="12" cy="5" r="1"></circle>
                        <circle cx="12" cy="19" r="1"></circle>
                    </svg>
                </button>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 gap-3 mt-auto">
                <!-- Category Box -->
                <div
                    class="bg-dark-bg/60 p-2.5 rounded border border-dark-border relative overflow-hidden group/box hover:border-gray-600 transition-colors">
                    <div
                        class="text-[9px] font-black text-gray-500 uppercase tracking-widest mb-1 group-hover/box:text-gray-400">
                        CATEGORÍA</div>
                    <div class="font-bold text-white text-sm truncate">
                        {{ team.teamCategory?.name || '-' }}
                    </div>
                </div>

                <!-- Level Box -->
                <div
                    class="bg-dark-bg/60 p-2.5 rounded border border-dark-border relative overflow-hidden group/box hover:border-gray-600 transition-colors">
                    <div
                        class="text-[9px] font-black text-gray-500 uppercase tracking-widest mb-1 group-hover/box:text-gray-400">
                        NIVEL</div>
                    <div class="font-bold text-white text-sm truncate">
                        {{ team.teamLevel?.name || '-' }}
                    </div>
                </div>

                <!-- Technical Level Box -->
                <div
                    class="bg-dark-bg/60 p-2.5 rounded border border-dark-border relative overflow-hidden group/box hover:border-primary/50 transition-colors">
                    <div class="text-[9px] font-black text-primary uppercase tracking-widest mb-1">TÉCNICA</div>
                    <div class="flex items-end gap-0.5">
                        <span class="font-bold text-white text-lg leading-none">{{ team.currentTechnicalLevel || '-'
                            }}</span>
                        <span class="text-[10px] text-gray-500 mb-0.5">/10</span>
                    </div>
                    <!-- Mini bar representation -->
                    <div class="w-full h-0.5 bg-dark-surface mt-1.5 rounded-full overflow-hidden">
                        <div class="h-full bg-primary" [style.width.%]="(team.currentTechnicalLevel || 0) * 10"></div>
                    </div>
                </div>

                <!-- Tactical Level Box -->
                <div
                    class="bg-dark-bg/60 p-2.5 rounded border border-dark-border relative overflow-hidden group/box hover:border-secondary/50 transition-colors">
                    <div class="text-[9px] font-black text-secondary uppercase tracking-widest mb-1">TÁCTICA</div>
                    <div class="flex items-end gap-0.5">
                        <span class="font-bold text-white text-lg leading-none">{{ team.currentTacticalLevel || '-'
                            }}</span>
                        <span class="text-[10px] text-gray-500 mb-0.5">/10</span>
                    </div>
                    <!-- Mini bar representation -->
                    <div class="w-full h-0.5 bg-dark-surface mt-1.5 rounded-full overflow-hidden">
                        <div class="h-full bg-secondary" [style.width.%]="(team.currentTacticalLevel || 0) * 10"></div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Radial Menu Overlay -->
        <div *ngIf="activeMenuId() === team.id"
            class="absolute inset-0 z-20 bg-black/80 backdrop-blur-sm flex items-center justify-center animate-in fade-in duration-200"
            (click)="closeMenu()">

            <!-- Center Close Button -->
            <button (click)="closeMenu()"
                class="absolute z-30 w-12 h-12 bg-white text-black rounded-full shadow-[0_0_20px_rgba(255,255,255,0.3)] flex items-center justify-center hover:bg-gray-200 hover:scale-105 transition-all duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <!-- Radial Items -->
            <!-- 1. View (Top) -->
            <div class="absolute w-10 h-10 transition-all duration-300 animate-in zoom-in slide-in-from-bottom-4 fade-in fill-mode-both"
                style="transform: translate(0px, -80px); animation-delay: 0ms;">
                <button (click)="viewTeam(team); $event.stopPropagation()"
                    class="w-full h-full rounded-full bg-cyan-500 text-white shadow-[0_0_15px_rgba(6,182,212,0.5)] flex items-center justify-center hover:scale-125 transition-transform group/btn relative">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                    <span
                        class="absolute -top-7 left-1/2 -translate-x-1/2 bg-cyan-500 text-black text-[9px] font-bold px-1.5 py-0.5 rounded opacity-0 group-hover/btn:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">DETALLES</span>
                </button>
            </div>

            <!-- 2. Planning (Top Right) -->
            <div class="absolute w-10 h-10 transition-all duration-300 animate-in zoom-in slide-in-from-bottom-4 fade-in fill-mode-both"
                style="transform: translate(76px, -25px); animation-delay: 50ms;">
                <button (click)="managePlanning(team); $event.stopPropagation()"
                    class="w-full h-full rounded-full bg-violet-500 text-white shadow-[0_0_15px_rgba(139,92,246,0.5)] flex items-center justify-center hover:scale-125 transition-transform group/btn relative">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                    <span
                        class="absolute -top-7 left-1/2 -translate-x-1/2 bg-violet-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded opacity-0 group-hover/btn:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">PLANIFICAR</span>
                </button>
            </div>

            <!-- 3. Edit (Bottom Right) -->
            <div class="absolute w-10 h-10 transition-all duration-300 animate-in zoom-in slide-in-from-bottom-4 fade-in fill-mode-both"
                style="transform: translate(47px, 64px); animation-delay: 100ms;">
                <button (click)="editTeam(team); $event.stopPropagation()"
                    class="w-full h-full rounded-full bg-amber-500 text-black shadow-[0_0_15px_rgba(245,158,11,0.5)] flex items-center justify-center hover:scale-125 transition-transform group/btn relative">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />
                    </svg>
                    <span
                        class="absolute -bottom-7 left-1/2 -translate-x-1/2 bg-amber-500 text-black text-[9px] font-bold px-1.5 py-0.5 rounded opacity-0 group-hover/btn:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">EDITAR</span>
                </button>
            </div>

            <!-- 4. Toggle Active (Bottom Left) -->
            <div class="absolute w-10 h-10 transition-all duration-300 animate-in zoom-in slide-in-from-bottom-4 fade-in fill-mode-both"
                style="transform: translate(-47px, 64px); animation-delay: 150ms;">
                <button (click)="toggleTeamActive(team); $event.stopPropagation()"
                    [class]="'w-full h-full rounded-full text-white shadow-[0_0_15px] flex items-center justify-center hover:scale-125 transition-transform group/btn relative ' + (team.isActive ? 'bg-rose-500 shadow-rose-500/50' : 'bg-emerald-500 shadow-emerald-500/50')">
                    <svg *ngIf="team.isActive" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                        stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12" />
                    </svg>
                    <svg *ngIf="!team.isActive" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                        stroke-linejoin="round">
                        <rect x="2" y="2" width="20" height="8" rx="2" ry="2" />
                        <rect x="2" y="14" width="20" height="8" rx="2" ry="2" />
                        <line x1="6" y1="6" x2="6.01" y2="6" />
                        <line x1="6" y1="18" x2="6.01" y2="18" />
                    </svg>
                    <span
                        [class]="'absolute -bottom-7 left-1/2 -translate-x-1/2 text-white text-[9px] font-bold px-1.5 py-0.5 rounded opacity-0 group-hover/btn:opacity-100 transition-opacity whitespace-nowrap pointer-events-none ' + (team.isActive ? 'bg-rose-500' : 'bg-emerald-500')">
                        {{ team.isActive ? 'DESACTIVAR' : 'ACTIVAR' }}
                    </span>
                </button>
            </div>

            <!-- 5. Delete (Top Left) -->
            <div class="absolute w-10 h-10 transition-all duration-300 animate-in zoom-in slide-in-from-bottom-4 fade-in fill-mode-both"
                style="transform: translate(-76px, -25px); animation-delay: 200ms;">
                <button (click)="deleteTeam(team); $event.stopPropagation()"
                    class="w-full h-full rounded-full bg-red-600 text-white shadow-[0_0_15px_rgba(220,38,38,0.5)] flex items-center justify-center hover:scale-125 transition-transform group/btn relative">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6" />
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                        <line x1="10" y1="11" x2="10" y2="17" />
                        <line x1="14" y1="11" x2="14" y2="17" />
                    </svg>
                    <span
                        class="absolute -top-7 left-1/2 -translate-x-1/2 bg-red-600 text-white text-[9px] font-bold px-1.5 py-0.5 rounded opacity-0 group-hover/btn:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">ELIMINAR</span>
                </button>
            </div>

        </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="teams().length === 0 && !isLoading()"
        class="col-span-full flex flex-col items-center justify-center py-16 border-2 border-dashed border-dark-border bg-dark-bg/30 rounded-lg">
        <div class="p-4 bg-dark-surface rounded-full mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="text-gray-600">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        </div>
        <p class="text-gray-400 font-bold text-lg">No tienes equipos creados</p>
        <p class="text-gray-600 text-sm mt-2 mb-6">Comienza creando tu primer equipo para gestionar entrenamientos</p>
        <button (click)="toggleForm()"
            class="px-6 py-2 bg-dark-surface border border-primary text-primary font-bold uppercase text-sm hover:bg-primary hover:text-black transition-all">
            Crear mi primer equipo
        </button>
    </div>
</div>

<!-- Delete Confirmation Dialog -->
<app-confirm-dialog [isVisible]="showDeleteDialog()" [isLoading]="isDeletingTeam()"
    title="¿Estás seguro de eliminar este equipo?"
    [message]="teamToDelete() ? 'Estás a punto de eliminar permanentemente el equipo ' + teamToDelete().name + '. Esta acción no se puede deshacer.' : ''"
    confirmText="Eliminar" cancelText="Cancelar" (confirm)="confirmDeleteTeam()" (cancel)="cancelDeleteTeam()"
    (visibilityChange)="showDeleteDialog.set($event)">
</app-confirm-dialog>

<!-- Loading State -->
<div *ngIf="isLoading()" class="flex justify-center items-center py-12">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
</div>
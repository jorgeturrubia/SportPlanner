<div class="mb-8">
    <h2 class="text-3xl md:text-4xl font-black text-white mb-2 tracking-tight">
        {{ planningId ? 'EDITAR PLANIFICACIÓN' : 'PLANIFICACIÓN DEL EQUIPO' }}
    </h2>
    <p class="text-gray-400 text-lg">Configura el calendario y objetivos de entrenamiento.</p>
</div>

<div class="bg-dark-surface border border-dark-border p-6 md:p-8">
    <!-- Steps Indicator -->
    <div class="flex mb-8 items-center justify-center">
        <div
            [class]="'w-10 h-10 rounded-full flex items-center justify-center font-bold transition-colors duration-300 ' + (step() >= 1 ? 'bg-primary text-black' : 'bg-dark-bg text-gray-500 border border-gray-700')">
            1</div>
        <div class="w-24 h-1 bg-dark-bg mx-2 relative">
            <div [class]="'absolute top-0 left-0 h-full bg-primary transition-all duration-500 ease-out'"
                [style.width]="step() >= 2 ? '100%' : '0%'"></div>
        </div>
        <div
            [class]="'w-10 h-10 rounded-full flex items-center justify-center font-bold transition-colors duration-300 delay-150 ' + (step() >= 2 ? 'bg-primary text-black' : 'bg-dark-bg text-gray-500 border border-gray-700')">
            2</div>
    </div>

    <form [formGroup]="planForm" (ngSubmit)="onSubmit()">
        <!-- STEP 1: Schedule -->
        <div *ngIf="step() === 1" class="animate-in fade-in slide-in-from-right-4 duration-300">
            <h3 class="text-xl font-bold text-white mb-6 border-b border-dark-border pb-2">Configuración de Calendario
            </h3>

            <!-- Row 1: Name, Start, End -->
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-8 items-end">
                <div class="md:col-span-6">
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">Nombre
                        (Opcional)</label>
                    <input type="text" formControlName="name"
                        class="w-full bg-dark-bg border border-dark-border p-2 text-white focus:border-primary outline-none transition-colors rounded text-sm"
                        placeholder="Ej: Pretemporada 2024">
                </div>
                <div class="md:col-span-3">
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">Inicio</label>
                    <input type="date" formControlName="startDate"
                        class="w-full bg-dark-bg border border-dark-border p-2 text-white focus:border-primary outline-none transition-colors rounded text-sm">
                </div>
                <div class="md:col-span-3">
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">Fin</label>
                    <input type="date" formControlName="endDate"
                        class="w-full bg-dark-bg border border-dark-border p-2 text-white focus:border-primary outline-none transition-colors rounded text-sm">
                </div>
            </div>

            <!-- Row 2: Days Selector -->
            <div class="mb-8">
                <label class="block text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">Días de
                    Entrenamiento</label>
                <div class="flex flex-wrap gap-2">
                    <button type="button" *ngFor="let day of weekDays; let i = index" (click)="toggleDay(i)" [class]="'px-4 py-2 rounded font-bold text-sm transition-all duration-200 border ' + 
                        (isDaySelected(i) 
                            ? 'bg-primary text-black border-primary shadow-[0_0_10px_rgba(34,197,94,0.3)]' 
                            : 'bg-dark-bg text-gray-400 border-dark-border hover:border-gray-500 hover:text-white')">
                        {{ day.substring(0, 3) }}
                    </button>
                </div>
            </div>

            <!-- Row 3: Time Configuration (Only for selected days) -->
            <div class="mb-8" *ngIf="selectedDaysIndices.length > 0">
                <label class="block text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">Horarios</label>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" formArrayName="days">
                    <ng-container *ngFor="let dayIndex of selectedDaysIndices">
                        <div [formGroupName]="dayIndex"
                            class="bg-dark-bg border border-dark-border p-3 rounded flex flex-col gap-2 animate-in zoom-in-95 duration-200">
                            <div class="font-bold text-white text-sm border-b border-dark-border pb-1 mb-1">{{
                                weekDays[dayIndex] }}</div>
                            <div class="flex items-center gap-2">
                                <input type="time" formControlName="startTime"
                                    class="bg-dark-surface border border-dark-border p-1 text-white text-xs w-full rounded focus:border-primary outline-none text-center">
                                <span class="text-gray-500">-</span>
                                <input type="time" formControlName="endTime"
                                    class="bg-dark-surface border border-dark-border p-1 text-white text-xs w-full rounded focus:border-primary outline-none text-center">
                            </div>
                        </div>
                    </ng-container>
                </div>
            </div>

            <div class="flex justify-end">
                <button type="button" (click)="nextStep()" [disabled]="!isStep1Valid()"
                    class="px-8 py-3 bg-primary text-black font-bold uppercase tracking-wider hover:bg-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed rounded shadow-lg shadow-primary/20">
                    SIGUIENTE
                </button>
            </div>
        </div>

        <!-- STEP 2: Concepts -->
        <div *ngIf="step() === 2" class="animate-in fade-in slide-in-from-right-4 duration-300">
            <h3 class="text-xl font-bold text-white mb-2">Propuesta de Conceptos</h3>
            <p class="text-gray-400 mb-6 border-b border-dark-border pb-4">Basado en la categoría y nivel de tu equipo,
                te sugerimos trabajar estos conceptos.</p>

            <div *ngIf="isLoadingConcepts()" class="flex justify-center py-20">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
            </div>

            <div *ngIf="!isLoadingConcepts()">
                <!-- Filter Controls (Badge Buttons) -->
                <div class="mb-6 p-4 bg-dark-bg border border-dark-border rounded">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Category Filter Badges -->
                        <div>
                            <label
                                class="block text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">Categorías</label>
                            <div class="flex flex-wrap gap-2">
                                <button type="button" *ngFor="let cat of availableCategories()"
                                    (click)="setCategoryFilter(selectedCategoryFilter() === cat.id ? null : cat.id)"
                                    [class]="'px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide transition-all duration-200 ' + 
                                        (selectedCategoryFilter() === cat.id 
                                            ? 'bg-primary text-black shadow-[0_0_10px_rgba(34,197,94,0.3)]' 
                                            : 'bg-dark-surface text-gray-400 border border-dark-border hover:border-primary hover:text-white')">
                                    {{ cat.name }}
                                </button>
                            </div>
                        </div>

                        <!-- Subcategory Filter Badges -->
                        <div *ngIf="selectedCategoryFilter()">
                            <label
                                class="block text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">Subcategorías</label>
                            <div class="flex flex-wrap gap-2">
                                <button type="button" *ngFor="let sub of availableSubcategories()"
                                    (click)="setSubcategoryFilter(selectedSubcategoryFilter() === sub.id ? null : sub.id)"
                                    [class]="'px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide transition-all duration-200 ' + 
                                        (selectedSubcategoryFilter() === sub.id 
                                            ? 'bg-secondary text-black shadow-[0_0_10px_rgba(255,193,7,0.3)]' 
                                            : 'bg-dark-surface text-gray-400 border border-dark-border hover:border-secondary hover:text-white')">
                                    {{ sub.name }}
                                </button>
                                <span *ngIf="availableSubcategories().length === 0"
                                    class="text-xs text-gray-500 italic py-1">
                                    Selecciona una categoría
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Concepts List -->
                <div class="space-y-6 mb-8 max-h-[600px] overflow-y-auto pr-2">
                    <!-- Category Groups -->
                    <div *ngFor="let categoryGroup of groupedConcepts()"
                        class="border border-dark-border rounded overflow-hidden">
                        <!-- Category Header (Collapsible) -->
                        <div (click)="toggleCategory(categoryGroup.categoryId)"
                            class="bg-dark-bg border-b border-dark-border px-4 py-2 cursor-pointer hover:bg-dark-surface transition-colors flex items-center justify-between">
                            <h4 class="text-sm font-bold text-primary uppercase tracking-wider">{{
                                categoryGroup.category }}</h4>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="text-primary transition-transform duration-200"
                                [class.rotate-180]="!isCategoryCollapsed(categoryGroup.categoryId)">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>

                        <!-- Subcategories (Collapsible based on category) -->
                        <div *ngIf="!isCategoryCollapsed(categoryGroup.categoryId)">
                            <div *ngFor="let subcategory of categoryGroup.subcategories"
                                class="border-b border-dark-border last:border-b-0">
                                <!-- Subcategory Header (Collapsible) -->
                                <div (click)="toggleSubcategory(categoryGroup.categoryId, subcategory.id)"
                                    class="bg-dark-surface px-4 py-1.5 border-b border-dark-border/50 cursor-pointer hover:bg-dark-bg/50 transition-colors flex items-center justify-between">
                                    <h5 class="text-xs font-bold text-gray-400 uppercase tracking-wide">{{
                                        subcategory.name }}</h5>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="text-gray-400 transition-transform duration-200"
                                        [class.rotate-180]="!isSubcategoryCollapsed(categoryGroup.categoryId, subcategory.id)">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </div>

                                <!-- Concepts in this subcategory (Collapsible based on subcategory) -->
                                <div *ngIf="!isSubcategoryCollapsed(categoryGroup.categoryId, subcategory.id)"
                                    class="divide-y divide-dark-border/30">
                                    <div *ngFor="let concept of subcategory.concepts"
                                        (click)="toggleConcept(concept.id)"
                                        [class]="'px-4 py-2 cursor-pointer transition-all duration-150 flex items-center gap-3 hover:bg-dark-bg ' + 
                                            (isConceptSelected(concept.id) ? 'bg-primary/5 border-l-2 border-l-primary' : '')">
                                        <!-- Checkbox -->
                                        <div
                                            [class]="'w-4 h-4 rounded border flex items-center justify-center flex-shrink-0 transition-colors ' + 
                                            (isConceptSelected(concept.id) ? 'bg-primary border-primary' : 'border-gray-600')">
                                            <svg *ngIf="isConceptSelected(concept.id)"
                                                xmlns="http://www.w3.org/2000/svg" width="12" height="12"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                                                stroke-linecap="round" stroke-linejoin="round" class="text-black">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                        </div>

                                        <!-- Concept Info -->
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-baseline gap-2">
                                                <span class="text-sm font-semibold text-white truncate">{{ concept.name
                                                    }}</span>
                                                <span *ngIf="concept.isSuggested"
                                                    class="text-[9px] font-bold bg-primary/20 text-primary border border-primary/30 px-1.5 py-0.5 rounded uppercase flex-shrink-0 animate-pulse">
                                                    SUGERIDO
                                                </span>
                                                <span *ngIf="concept.difficultyLevel"
                                                    class="text-[9px] font-bold border border-gray-600 text-gray-500 px-1.5 py-0.5 rounded uppercase flex-shrink-0">
                                                    {{ concept.difficultyLevel.name }}
                                                </span>
                                            </div>
                                            <p *ngIf="concept.description"
                                                class="text-xs text-gray-500 truncate mt-0.5">
                                                {{ concept.description }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-between pt-4 border-t border-dark-border">
                <button type="button" (click)="prevStep()"
                    class="px-8 py-3 bg-transparent border border-dark-border text-white font-bold uppercase tracking-wider hover:bg-dark-bg hover:border-gray-400 transition-colors rounded">
                    ATRÁS
                </button>
                <button type="submit" [disabled]="isLoading()"
                    class="px-8 py-3 bg-secondary text-black font-bold uppercase tracking-wider hover:bg-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed rounded shadow-lg shadow-secondary/20">
                    {{ isLoading() ? 'GUARDANDO...' : (planningId ? 'ACTUALIZAR PLANIFICACIÓN' : 'FINALIZAR
                    PLANIFICACIÓN') }}
                </button>
            </div>
        </div>
    </form>
</div>
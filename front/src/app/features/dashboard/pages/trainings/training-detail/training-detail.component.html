<div class="h-full flex flex-col bg-dark-bg text-white font-sans selection:bg-primary/30">
    <!-- 1. COMPACT HEADER (Merged) -->
    <header class="h-14 border-b border-dark-border bg-dark-surface/95 backdrop-blur flex items-center justify-between px-4 shrink-0 z-20 shadow-sm">
        
        <!-- Left: Back & Title -->
        <div class="flex items-center gap-3 flex-1 min-w-0">
            <button (click)="cancel()" class="p-1.5 -ml-2 hover:bg-white/5 rounded-full text-gray-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
            </button>
            <div class="h-6 w-px bg-dark-border"></div>
            
            <!-- Editable Title & Meta Inline -->
            <div class="flex items-center gap-4 flex-1 overflow-hidden">
                <input [ngModel]="name()" (ngModelChange)="name.set($event)" type="text"
                    placeholder="Nombre de la sesión..."
                    class="bg-transparent border-none p-0 text-lg font-black text-white focus:ring-0 placeholder-gray-600 truncate min-w-[200px]">
                
                 <!-- Planning Badge / Selector -->
                 <div class="relative group hidden md:block">
                     <select [ngModel]="planningId()" (ngModelChange)="onPlanningChange($event)" [disabled]="true"
                        class="appearance-none bg-dark-bg border border-dark-border text-[10px] font-bold text-primary px-2 py-0.5 rounded cursor-not-allowed opacity-70 focus:outline-none pr-6 uppercase tracking-wider">
                         <option [value]="null">S. LIBRE</option>
                         @for (p of allPlannings(); track p.id) {
                         <option [value]="p.id">{{ p.name }}</option>
                         }
                     </select>
                     <div class="absolute inset-y-0 right-1 flex items-center pointer-events-none">
                        <svg class="w-3 h-3 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                     </div>
                 </div>
            </div>
        </div>

        <!-- Right: Time, Duration & Actions -->
        <div class="flex items-center gap-3">
            <!-- Date/Time Compact -->
             <div class="flex items-center gap-2 bg-dark-bg/50 px-2 py-1 rounded border border-dark-border/50 text-xs">
                 <input [ngModel]="date()" (ngModelChange)="date.set($event)" type="date" class="bg-transparent border-none p-0 w-24 text-gray-300 font-bold focus:ring-0 text-right [color-scheme:dark]">
                 <span class="text-gray-600">@</span>
                 <input [ngModel]="startTime()" (ngModelChange)="startTime.set($event)" type="time" class="bg-transparent border-none p-0 w-16 text-gray-300 font-bold focus:ring-0 [color-scheme:dark]">
             </div>

             <div class="h-6 w-px bg-dark-border"></div>

             <div class="text-right hidden sm:block">
                 <div class="text-[9px] text-gray-500 uppercase font-black tracking-widest">Duración</div>
                 <div class="text-sm font-black text-secondary leading-none">{{ totalDuration() }}</div>
             </div>

             <div class="flex gap-2 ml-2">
                 <button (click)="save()" [disabled]="saving()" 
                    class="px-4 py-1.5 bg-primary text-black text-xs font-black uppercase tracking-wider rounded hover:bg-white transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                     <span *ngIf="saving()" class="w-3 h-3 border-2 border-black border-t-transparent rounded-full animate-spin"></span>
                     {{ saving() ? 'GUARDANDO' : 'GUARDAR' }}
                 </button>
             </div>
        </div>
    </header>

    <!-- 2. MAIN SHEET CONTENT (Table/List View) -->
    <main class="flex-1 overflow-hidden flex flex-col relative">

        <!-- Scrollable List -->
        <div class="flex-1 overflow-y-auto scrollbar-thin bg-dark-bg pb-32 space-y-2 p-4" cdkDropList (cdkDropListDropped)="drop($event)">
            
            @if (trainingConcepts().length === 0) {
            <div class="flex flex-col items-center justify-center p-12 text-gray-600 opacity-60">
                <div class="w-16 h-16 border-2 border-dashed border-current rounded-xl flex items-center justify-center mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </div>
                <p class="text-sm font-bold uppercase tracking-wider">Planilla Vacía</p>
                <p class="text-xs mt-1">Usa la barra inferior para añadir conceptos rápidamente</p>
            </div>
            }

            @for (concept of trainingConcepts(); track concept.id; let i = $index) {
            <div cdkDrag class="group bg-dark-surface border border-dark-border rounded-lg overflow-hidden hover:border-dark-border/80 transition-all shadow-sm">
                
                <!-- Main Header Row: Concept Info + Time + Tools -->
                <div class="flex items-start gap-3 p-3 bg-gradient-to-r from-dark-surface to-dark-bg">
                    
                    <!-- 1. Drag & Index -->
                    <div class="flex flex-col items-center justify-start pt-1 gap-1">
                        <div cdkDragHandle class="cursor-move text-gray-600 hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="19" r="1"/></svg>
                        </div>
                        <span class="text-[10px] font-mono text-gray-600 font-bold">{{ i + 1 }}</span>
                    </div>

                    <!-- 2. Concept Details -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                             <span *ngIf="concept.categoryName" class="text-[9px] px-1.5 py-px rounded bg-dark-active border border-dark-border text-primary font-bold uppercase tracking-wider truncate max-w-[120px]">
                                {{ concept.categoryName }}
                            </span>
                            @if (concept.isEditing) {
                                <input autoFocus type="text" [(ngModel)]="concept.editName" (keydown.enter)="saveConceptName(concept)" (blur)="saveConceptName(concept)" 
                                    class="bg-black border border-primary text-white text-sm font-bold px-2 py-0.5 rounded w-full focus:outline-none">
                            } @else {
                                <div class="flex items-center gap-2 group/title cursor-pointer" (click)="toggleEdit(concept)">
                                    <h3 class="text-sm font-black text-white truncate uppercase tracking-tight leading-none">{{ concept.name }}</h3>
                                    <svg class="opacity-0 group-hover/title:opacity-100 text-gray-500 w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                </div>
                            }
                        </div>
                        <p class="text-[11px] text-gray-500 leading-tight line-clamp-2 md:line-clamp-1 mb-2">{{ concept.description || 'Añade una descripción para este objetivo...' }}</p>
                        
                        <!-- Time Input (Moved here as requested "abajo el tiempo") -->
                        <div class="flex items-center gap-1.5">
                            <div class="flex items-center bg-dark-bg border border-dark-border rounded px-1.5 py-0.5">
                                <svg class="w-3 h-3 text-secondary mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                <input type="number" [(ngModel)]="concept.durationMinutes" (ngModelChange)="updateDuration()"
                                    class="w-8 bg-transparent text-center text-[10px] font-bold text-white focus:outline-none p-0 [appearance:textfield]" min="1">
                                <span class="text-[9px] text-gray-500 font-bold">min</span>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Add Tools (Right Side) -->
                    <div class="flex items-start gap-2 pt-1 border-l border-dark-border/50 pl-3">
                        <div class="flex flex-col gap-1 items-end">
                            <!-- Add Library Exercise -->
                            <button (click)="openLibrary(concept.id)" class="btn btn-xs btn-outline border-dark-border text-gray-400 hover:text-white hover:border-primary w-full flex items-center justify-center gap-1 h-7">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span class="text-[9px] font-bold uppercase hidden xl:inline">Biblioteca</span>
                            </button>
                            
                            <!-- Quick Text Input for Exercise -->
                             <div class="relative w-32 xl:w-48">
                                <input type="text" #customExInput (keydown.enter)="addCustomExercise(concept.id, customExInput.value); customExInput.value = ''"
                                    placeholder="+ Escribir Ejercicio..."
                                    class="w-full bg-dark-bg border border-dark-border rounded px-2 py-1 text-[10px] text-white placeholder-gray-600 focus:border-primary focus:ring-0 focus:outline-none h-7">
                             </div>
                        </div>

                         <!-- Delete Concept -->
                         <button (click)="removeConcept(i)" class="text-gray-600 hover:text-danger p-1.5 rounded hover:bg-danger/10 transition-colors ml-1">
                             <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                         </button>
                    </div>
                </div>

                <!-- 4. Selected Exercises List (Always Visible "DEBAJO") -->
                @if (concept.exercises.length > 0) {
                    <div class="bg-black/20 border-t border-dark-border/30 px-3 py-2 space-y-1">
                        @for (exercise of concept.exercises; track exercise.id || exercise.customText; let exIdx = $index) {
                            <div class="flex items-center gap-3 pl-2 py-1.5 group/ex hover:bg-white/5 rounded border border-transparent hover:border-dark-border/50 transition-all">
                                <div class="w-1 h-3 bg-primary rounded-full"></div>
                                <span class="text-xs text-gray-300 font-medium flex-1 truncate">{{ exercise.exerciseName || exercise.customText }}</span>
                                <input type="number" [(ngModel)]="exercise.durationMinutes" 
                                    class="w-10 bg-transparent text-right text-[10px] font-mono text-gray-500 focus:text-white focus:outline-none border-b border-transparent focus:border-gray-600" 
                                    placeholder="Min">
                                <span class="text-[9px] text-gray-600 mr-2">min</span>
                                
                                <button (click)="removeExercise(concept.id, exIdx)" class="opacity-0 group-hover/ex:opacity-100 text-gray-600 hover:text-danger p-1">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>
            }
        </div>

        <!-- 3. FOOTER QUICK ADD (Sticky) -->
        <div class="absolute bottom-6 left-6 right-6 bg-dark-bg/90 backdrop-blur-md border border-dark-border rounded-lg shadow-2xl p-2 flex items-center gap-2 ring-1 ring-white/5 z-30 animate-slide-up">
            
            <div class="pl-3 text-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>
            
            <input type="text" [ngModel]="quickConceptName()" (ngModelChange)="quickConceptName.set($event)"
                (keyup.enter)="addQuickConcept()"
                placeholder="Añadir nuevo concepto / objetivo a la sesión..."
                class="flex-1 bg-transparent border-none text-sm font-bold text-white placeholder-gray-500 focus:ring-0 py-2">
            
            <div class="h-6 w-px bg-dark-border mx-1"></div>

            <button (click)="openConceptModal()" class="px-3 py-1.5 rounded hover:bg-dark-surface text-[10px] font-black uppercase tracking-wider text-gray-400 hover:text-white transition-colors flex items-center gap-2">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                Explorar Biblioteca
            </button>
        </div>

    </main>

    <!-- Modal Templates Reuse (Concept Modal & Library Modal) -->
    <!-- Ideally these should be separate components but keeping logical continuity valid -->
    <!-- Using existing templates references -->
    <ng-template #conceptModalTemplate>
         <div class="bg-dark-surface border border-dark-border w-full max-w-4xl rounded-xl shadow-2xl flex flex-col h-[85vh] overflow-hidden animate-fade-in-up m-4 pointer-events-auto">
             <!-- Modal Header -->
             <div class="p-4 border-b border-dark-border flex justify-between items-center bg-dark-bg shrink-0">
                 <div>
                     <h3 class="text-lg font-black text-white italic uppercase tracking-tighter">Seleccionar Conceptos</h3>
                     <p class="text-[10px] text-gray-500 font-bold uppercase">Planificación: {{ activePlanning()?.name || 'S. Libre' }}</p>
                 </div>
                 <div class="flex items-center gap-4">
                     <span class="text-xs text-primary font-bold uppercase tracking-wider">{{ trainingConcepts().length }} Seleccionados</span>
                     <button (click)="closeConceptModal()" class="text-gray-400 hover:text-white p-1 hover:bg-white/10 rounded-full transition-colors">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>
                     </button>
                 </div>
             </div>
             
             <!-- Compact Grouped List -->
             <div class="flex-1 overflow-y-auto bg-dark-bg p-4 space-y-4">
                 @if (groupedConcepts().length === 0) {
                     <div class="text-center py-12 text-gray-500">
                         <p class="text-sm font-bold uppercase">No hay conceptos disponibles</p>
                     </div>
                 }

                 @for (group of groupedConcepts(); track group.parentName + group.subName) {
                     <div class="animate-fade-in">
                         <!-- Group Header -->
                         <div class="flex items-center gap-2 mb-2 sticky top-0 bg-dark-bg/95 backdrop-blur z-10 py-1 border-b border-dark-border/50">
                             <div class="w-1 h-3 bg-secondary rounded-full"></div>
                             <h4 class="text-xs font-black text-gray-300 uppercase tracking-wide">
                                 <span class="text-gray-500">{{ group.parentName }}</span> 
                                 <span class="mx-1 text-gray-600">/</span> 
                                 <span class="text-white">{{ group.subName }}</span>
                             </h4>
                         </div>

                         <!-- Concepts Grid (Dense) -->
                         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 pl-3">
                             @for (concept of group.items; track concept.id) {
                                 <button (click)="addConcept(concept)" 
                                    class="text-left px-3 py-2 rounded border transition-all relative group flex items-start gap-2"
                                    [class.bg-primary-dark]="isConceptSelected(concept.id)"
                                    [class.border-primary]="isConceptSelected(concept.id)"
                                    [class.bg-dark-surface]="!isConceptSelected(concept.id)"
                                    [class.border-dark-border]="!isConceptSelected(concept.id)"
                                    [class.hover:border-gray-500]="!isConceptSelected(concept.id)">
                                     
                                     <!-- Checkbox visuals -->
                                     <div class="mt-0.5 w-4 h-4 rounded border flex items-center justify-center shrink-0 transition-colors"
                                        [class.bg-primary]="isConceptSelected(concept.id)"
                                        [class.border-primary]="isConceptSelected(concept.id)"
                                        [class.border-gray-600]="!isConceptSelected(concept.id)">
                                         <svg *ngIf="isConceptSelected(concept.id)" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                     </div>

                                     <div class="min-w-0">
                                         <div class="text-xs font-bold truncate leading-tight" 
                                            [class.text-white]="isConceptSelected(concept.id)"
                                            [class.text-gray-300]="!isConceptSelected(concept.id)">
                                             {{ concept.name }}
                                         </div>
                                         <div class="text-[9px] text-gray-500 truncate group-hover:text-gray-400 transition-colors">
                                             {{ concept.description || 'Sin descripción' }}
                                         </div>
                                     </div>
                                 </button>
                             }
                         </div>
                     </div>
                 }
             </div>
             
             <!-- Footer Actions -->
             <div class="p-3 bg-dark-surface border-t border-dark-border flex justify-end">
                 <button (click)="closeConceptModal()" class="px-6 py-2 bg-white text-black text-xs font-black uppercase tracking-wider rounded hover:bg-gray-200 transition-colors">
                     Listo
                 </button>
             </div>
         </div>
    </ng-template>

    <ng-template #libraryModalTemplate>
        <div class="bg-dark-surface border border-dark-border w-full max-w-4xl rounded-xl shadow-2xl flex flex-col h-[75vh] m-4 pointer-events-auto">
            <div class="p-4 border-b border-dark-border flex justify-between items-center bg-dark-bg">
                <h3 class="text-lg font-black text-white italic uppercase">Ejercicios Disponibles</h3>
                <button (click)="closeLibraryModal()" class="text-gray-400 hover:text-white"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-dark-bg grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                @for (ex of libraryExercises(); track ex.id) {
                    <div (click)="addExerciseFromLibrary(ex)" class="cursor-pointer bg-dark-surface border border-dark-border p-3 rounded hover:border-primary group transition-all">
                        <div class="font-bold text-sm text-gray-200 group-hover:text-white mb-1">{{ ex.name }}</div>
                        <div class="text-[10px] text-gray-500 line-clamp-2">{{ ex.description }}</div>
                    </div>
                }
            </div>
        </div>
    </ng-template>

</div>
<div
    class="h-screen flex flex-col bg-[#121212] text-white overflow-hidden font-sans selection:bg-[#FF6B00] selection:text-black">

    <!-- Top Bar: Header & Global Timer -->
    <header class="flex items-center justify-between px-6 py-4 bg-[#1A1A1A] border-b-2 border-dark-border z-10">
        <div class="flex items-center gap-6">
            <button class="text-gray-400 hover:text-[#FF6B00] transition-colors duration-200"
                routerLink="/dashboard/trainings">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
            </button>
            <div>
                <h1 class="text-xl font-black uppercase tracking-tighter text-white truncate max-w-md">
                    {{ session()?.sessionDate | date:'mediumDate' }}
                </h1>
                <div class="flex items-center gap-3 text-xs font-mono uppercase tracking-widest text-gray-500">
                    <span class="flex items-center gap-2 px-2 py-0.5 border border-gray-700 bg-black/50" [ngClass]="{
                            'text-[#CCFF00] border-[#CCFF00]': state() === SessionExecutionState.Running,
                            'text-[#FF6B00] border-[#FF6B00]': state() === SessionExecutionState.Paused,
                            'text-gray-400 border-gray-600': state() === SessionExecutionState.Idle
                        }">
                        <span class="w-1.5 h-1.5 bg-current animate-pulse"></span>
                        {{ state() }}
                    </span>
                    <span>//</span>
                    <span class="text-gray-300">{{ session()?.teamName }}</span>
                </div>
            </div>
        </div>

        <!-- Global Timer (Small) -->
        <div class="flex flex-col items-end border-l border-gray-800 pl-6">
            <div class="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-0.5">Total Time</div>
            <div class="text-2xl font-mono font-bold text-[#CCFF00] tabular-nums tracking-wide leading-none">
                {{ formatTime(generalTime()) }}
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="flex-1 grid grid-cols-1 lg:grid-cols-3 p-6 gap-6 overflow-hidden max-w-7xl mx-auto w-full">

        <!-- Left Col: Active Exercise (Focus) -->
        <div class="lg:col-span-2 flex flex-col h-full">

            <!-- Loading State -->
            <div *ngIf="!session(); else sessionContent"
                class="flex-1 bg-[#1A1A1A] border-2 border-dark-border flex flex-col justify-center items-center">
                <div class="w-12 h-12 border-4 border-gray-800 border-t-[#CCFF00] rounded-full animate-spin mb-4"></div>
                <p class="font-mono text-sm text-gray-500 animate-pulse">LOADING TELEMETRY...</p>
            </div>

            <!-- Session Content (Loaded) -->
            <ng-template #sessionContent>
                <!-- Context: Active Exercise Card -->
                <div *ngIf="activeExercise(); else noExercise"
                    class="bg-[#1A1A1A] border-2 border-dark-border relative overflow-hidden flex-1 flex flex-col justify-center items-center group">

                    <!-- Corner Accents -->
                    <div class="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-[#FF6B00]"></div>
                    <div class="absolute top-0 right-0 w-4 h-4 border-t-2 border-r-2 border-[#FF6B00]"></div>
                    <div class="absolute bottom-0 left-0 w-4 h-4 border-b-2 border-l-2 border-[#FF6B00]"></div>
                    <div class="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-[#FF6B00]"></div>

                    <!-- Exercise Header -->
                    <div class="text-center z-10 mb-12 max-w-3xl px-8">
                        <h2
                            class="text-5xl md:text-6xl font-black text-white mb-6 uppercase tracking-tighter leading-none">
                            {{ activeExercise()?.exercise?.name }}
                        </h2>
                        <p
                            class="text-lg text-gray-400 font-mono tracking-tight bg-black/30 py-2 px-4 border border-gray-800 inline-block">
                            {{ activeExercise()?.exercise?.description }}
                        </p>
                    </div>

                    <!-- BIG TIMER (Countdown) -->
                    <div class="relative z-10 mb-16">
                        <div class="font-mono text-9xl md:text-[10rem] font-bold tabular-nums tracking-tighter leading-none"
                            [ngClass]="{
                                'text-[#CCFF00]': state() === SessionExecutionState.Running,
                                'text-[#FF6B00]': state() === SessionExecutionState.Paused,
                                'text-gray-600': state() === SessionExecutionState.Idle
                            }">
                            {{ formatTime(exerciseTime()) }}
                        </div>
                    </div>

                    <!-- Main Controls (Play/Pause) -->
                    <div class="flex items-center gap-12 z-10 mb-12">
                        <!-- Previous -->
                        <button (click)="prev()"
                            class="p-4 text-gray-600 hover:text-white hover:bg-white/5 border border-transparent hover:border-white/20 transition-all disabled:opacity-20 disabled:hover:bg-transparent"
                            [disabled]="executionService.currentExerciseIndex() === 0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M11 17l-5-5 5-5M18 17l-5-5 5-5" />
                            </svg>
                        </button>

                        <!-- Play/Pause Button -->
                        <button (click)="togglePlayPause()"
                            class="w-32 h-32 flex items-center justify-center border-2 transition-all duration-100 hover:scale-105 active:scale-95 group relative overflow-hidden"
                            [ngClass]="{
                                'border-[#FF6B00] text-[#FF6B00] hover:bg-[#FF6B00] hover:text-black': state() !== SessionExecutionState.Running,
                                'border-[#CCFF00] text-[#CCFF00] hover:bg-[#CCFF00] hover:text-black animate-neon-pulse': state() === SessionExecutionState.Running
                            }">

                            <!-- Play Icon -->
                            <svg *ngIf="state() !== SessionExecutionState.Running" xmlns="http://www.w3.org/2000/svg"
                                width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>

                            <!-- Pause Icon -->
                            <svg *ngIf="state() === SessionExecutionState.Running" xmlns="http://www.w3.org/2000/svg"
                                width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
                                <rect x="6" y="4" width="4" height="16"></rect>
                                <rect x="14" y="4" width="4" height="16"></rect>
                            </svg>
                        </button>

                        <!-- Next -->
                        <button (click)="next()"
                            class="p-4 text-gray-600 hover:text-white hover:bg-white/5 border border-transparent hover:border-white/20 transition-all disabled:opacity-20 disabled:hover:bg-transparent"
                            [disabled]="!nextExercise()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M13 17l5-5-5-5M6 17l5-5-5-5" />
                            </svg>
                        </button>
                    </div>

                    <!-- Progress Strip -->
                    <div class="absolute bottom-0 left-0 w-full h-1 bg-gray-900">
                        <div class="bg-[#FF6B00] h-full transition-all duration-300 linear shadow-[0_0_10px_rgba(255,107,0,0.5)]"
                            [style.width.%]="progressPercentage"></div>
                    </div>

                    <div class="absolute bottom-4 right-6 font-mono text-xs text-gray-500">
                        EXE {{ executionService.currentExerciseIndex() + 1 }} / {{ session()?.sessionExercises?.length
                        || 0
                        }}
                    </div>
                </div>

                <ng-template #noExercise>
                    <div
                        class="flex-1 bg-[#1A1A1A] border-2 border-dark-border flex flex-col justify-center items-center text-gray-400">
                        <h2 class="text-4xl font-black mb-4 text-white uppercase tracking-tighter">Sesión Completada
                        </h2>
                        <p class="font-mono text-sm">No hay más ejercicios en la secuencia.</p>
                    </div>
                </ng-template>
            </ng-template>

        </div>

        <!-- Right Col: Queue / Flow -->
        <div class="lg:col-span-1 h-full overflow-hidden flex flex-col">
            <div class="bg-[#1A1A1A] border-2 border-dark-border flex-1 p-0 overflow-y-auto flex flex-col relative">
                <h3
                    class="p-4 text-xs font-bold text-[#FF6B00] uppercase tracking-[0.2em] border-b-2 border-dark-border sticky top-0 bg-[#1A1A1A] z-10 flex justify-between items-center">
                    <span>Up Next</span>
                    <span class="text-[10px] text-gray-600 font-mono">QUEUE</span>
                </h3>

                <div class="flex-1">
                    <div *ngFor="let ex of session()?.sessionExercises; let i = index"
                        class="p-4 border-b border-gray-800 transition-all duration-200 group hover:bg-white/5 cursor-default"
                        [ngClass]="{
                            'bg-[#FF6B00]/10 !border-l-4 !border-l-[#FF6B00]': i === executionService.currentExerciseIndex(),
                            'opacity-40 grayscale': i < executionService.currentExerciseIndex(),
                            'opacity-70': i > executionService.currentExerciseIndex()
                        }">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-[10px] font-mono text-gray-500 group-hover:text-white transition-colors">
                                <span *ngIf="i < executionService.currentExerciseIndex()">DONE</span>
                                <span *ngIf="i === executionService.currentExerciseIndex()"
                                    class="text-[#FF6B00]">ACTIVE</span>
                                <span *ngIf="i > executionService.currentExerciseIndex()">#{{i + 1}}</span>
                            </span>
                            <span class="text-xs font-mono font-bold"
                                [class.text-[#CCFF00]]="i === executionService.currentExerciseIndex()"
                                [class.text-gray-500]="i !== executionService.currentExerciseIndex()">
                                {{ ex.durationMinutes }}m
                            </span>
                        </div>
                        <h4 class="font-bold text-sm uppercase tracking-tight leading-snug"
                            [class.text-white]="i === executionService.currentExerciseIndex()"
                            [class.text-gray-400]="i !== executionService.currentExerciseIndex()">
                            {{ ex.exercise.name }}
                        </h4>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>
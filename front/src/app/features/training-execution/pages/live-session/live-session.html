<div class="live-session-container" [class.paused]="currentState() === 'Paused'">

    <!-- LOADING OVERLAY -->
    <div class="loading-overlay" *ngIf="isLoading()">
        <div class="spinner"></div>
        <p>Cargando sesi√≥n...</p>
    </div>

    <!-- COMMAND CENTER HEADER -->
    <header class="session-header">
        <div class="header-info">
            <h1 class="session-title">{{ executionService.session()?.name || 'Entrenamiento' }}</h1>
            <span class="team-name">{{ executionService.session()?.planningName || 'Equipo' }}</span>
        </div>

        <div class="header-controls">
            <button class="mini-control" (click)="prevExercise()" title="Anterior">‚èÆ</button>
            <button class="play-control" (click)="togglePause()" [class.running]="currentState() === 'Running'">
                <span *ngIf="currentState() === 'Running'">‚è∏</span>
                <span *ngIf="currentState() !== 'Running'">‚ñ∂</span>
            </button>
            <button class="mini-control" (click)="goToNextExercise()" title="Siguiente">‚è≠</button>
        </div>

        <div class="header-right">
            <div class="global-timer-display">
                <span class="time">{{ generalTimeFormatted() }}</span>
            </div>
            <button class="finish-btn-mini" (click)="finishSession()">FINALIZAR</button>
        </div>
    </header>

    <div class="progress-bar-container">
        <div class="progress-bar" [style.width.%]="progressBarWidth()"></div>
    </div>

    <main class="dashboard-grid">
        <!-- COL 1: OVERVIEW -->
        <aside class="session-overview">
            <h3 class="panel-title">Plan</h3>
            <div class="exercise-list">
                @for (ex of allExercises(); track ex.id; let i = $index) {
                <div class="mini-exercise-card" [class.active]="i === executionService.currentExerciseIndex()"
                    [class.completed]="ex.isCompleted">
                    <span class="mini-order">{{ i + 1 }}</span>
                    <div class="mini-details">
                        <span class="mini-name">{{ ex.exercise?.name || 'Ejercicio' }}</span>
                    </div>
                </div>
                }
            </div>
        </aside>

        <!-- COL 2: MAIN STAGE (Refactored) -->
        <section class="stage-area">
            @if (activeExercise(); as active) {
            <div class="stage-content">

                <!-- TOP: INFO + TIMER -->
                <div class="stage-top-row">
                    <div class="stage-info">
                        <div class="info-badges">
                            <span class="badge concept" *ngIf="active.sportConceptName">{{ active.sportConceptName
                                }}</span>
                            <span class="badge counter">#{{ executionService.currentExerciseIndex() + 1 }}</span>
                        </div>
                        <h2 class="stage-title">{{ active.exercise?.name }}</h2>
                        <p class="stage-desc">{{ active.exercise?.description || 'Sin descripci√≥n.' }}</p>
                    </div>

                    <div class="stage-timer-wrapper">
                        <div class="exercise-timer-ring medium"
                            [class.urgent]="exerciseTime() < 60 && exerciseTime() > 0">
                            <div class="timer-value">{{ exerciseTimeFormatted() }}</div>
                        </div>
                    </div>
                </div>

                <!-- BOTTOM: MEDIA PREVIEW -->
                <div class="stage-media-container">
                    @if (active.exercise?.imageUrl) {
                    <img [src]="active.exercise?.imageUrl" alt="Preview" class="media-preview">
                    } @else {
                    <div class="no-preview">
                        <div class="no-preview-icon">üì∑</div>
                        <span>No preview available</span>
                    </div>
                    }
                </div>

            </div>
            } @else {
            <div class="empty-stage">
                <div class="placeholder-icon">üèÉ</div>
                <h2>Sin Ejercicio Activo</h2>
                <p>Selecciona un ejercicio del plan o inicia la sesi√≥n.</p>
            </div>
            }
        </section>

        <!-- COL 3: LOG -->
        <aside class="session-log-panel">
            <div class="log-header">
                <h3>Bit√°cora</h3>
            </div>

            <div class="quick-comment-box-top">
                <input type="text" [(ngModel)]="newComment" (keyup.enter)="addQuickComment()"
                    placeholder="Escribir nota..." class="comment-input" autofocus>
                <button class="send-btn" (click)="addQuickComment()">+</button>
            </div>

            <div class="log-list">
                @for (comment of comments(); track $index) {
                <div class="log-entry comment">
                    <span class="message">{{ comment }}</span>
                </div>
                }
            </div>
        </aside>
    </main>
</div>
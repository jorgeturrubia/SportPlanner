name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - teams
          - exercises
          - objectives
          - auth
          - performance
          - validation

env:
  NODE_VERSION: '20'
  DOTNET_VERSION: '8.0'

jobs:
  test:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: plansport_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'src/front/SportPlanner/package-lock.json'

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install frontend dependencies
        working-directory: src/front/SportPlanner
        run: npm ci

      - name: Install Playwright browsers
        working-directory: src/front/SportPlanner
        run: npx playwright install --with-deps

      - name: Restore .NET dependencies
        working-directory: src/back/SportPlanner
        run: dotnet restore

      - name: Build .NET API
        working-directory: src/back/SportPlanner/SportPlanner.Api
        run: dotnet build --no-restore

      - name: Build frontend
        working-directory: src/front/SportPlanner
        run: npm run build

      - name: Setup test environment variables
        run: |
          echo "PLAYWRIGHT_API_URL=http://localhost:5000" >> $GITHUB_ENV
          echo "PLAYWRIGHT_FRONTEND_URL=http://localhost:4200" >> $GITHUB_ENV
          echo "PLAYWRIGHT_SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> $GITHUB_ENV
          echo "PLAYWRIGHT_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> $GITHUB_ENV
          echo "PLAYWRIGHT_SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> $GITHUB_ENV

      - name: Setup test database
        working-directory: src/back/SportPlanner/SportPlanner.Api
        run: |
          dotnet ef database update --connection "Host=localhost;Database=plansport_test;Username=postgres;Password=postgres"
        env:
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=plansport_test;Username=postgres;Password=postgres"

      - name: Start .NET API
        working-directory: src/back/SportPlanner/SportPlanner.Api
        run: |
          dotnet run &
          echo $! > api.pid
          # Wait for API to be ready
          timeout 60 bash -c 'until curl -f http://localhost:5000/api/health; do sleep 2; done'
        env:
          ASPNETCORE_ENVIRONMENT: Testing
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=plansport_test;Username=postgres;Password=postgres"

      - name: Start frontend development server
        working-directory: src/front/SportPlanner
        run: |
          npm start &
          echo $! > frontend.pid
          # Wait for frontend to be ready
          timeout 60 bash -c 'until curl -f http://localhost:4200; do sleep 2; done'

      - name: Run E2E tests - All
        if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == '' }}
        working-directory: src/front/SportPlanner
        run: npx playwright test
        env:
          PLAYWRIGHT_API_URL: http://localhost:5000
          PLAYWRIGHT_FRONTEND_URL: http://localhost:4200

      - name: Run E2E tests - Teams
        if: ${{ github.event.inputs.test_suite == 'teams' }}
        working-directory: src/front/SportPlanner
        run: npx playwright test e2e/tests/teams/

      - name: Run E2E tests - Exercises
        if: ${{ github.event.inputs.test_suite == 'exercises' }}
        working-directory: src/front/SportPlanner
        run: npx playwright test e2e/tests/exercises/

      - name: Run E2E tests - Objectives
        if: ${{ github.event.inputs.test_suite == 'objectives' }}
        working-directory: src/front/SportPlanner
        run: npx playwright test e2e/tests/objectives/

      - name: Run E2E tests - Authentication
        if: ${{ github.event.inputs.test_suite == 'auth' }}
        working-directory: src/front/SportPlanner
        run: npx playwright test e2e/tests/auth/

      - name: Run E2E tests - Performance
        if: ${{ github.event.inputs.test_suite == 'performance' }}
        working-directory: src/front/SportPlanner
        run: npx playwright test e2e/tests/performance/

      - name: Run E2E tests - Validation
        if: ${{ github.event.inputs.test_suite == 'validation' }}
        working-directory: src/front/SportPlanner
        run: npx playwright test e2e/tests/validation/

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.os }}-${{ github.run_id }}
          path: src/front/SportPlanner/playwright-report/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-${{ matrix.os }}-${{ github.run_id }}
          path: |
            src/front/SportPlanner/e2e-results.json
            src/front/SportPlanner/e2e-results.xml
          retention-days: 30

      - name: Upload screenshots and videos
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-artifacts-${{ matrix.os }}-${{ github.run_id }}
          path: |
            src/front/SportPlanner/test-results/
          retention-days: 30

      - name: Stop services
        if: always()
        run: |
          # Stop frontend
          if [ -f src/front/SportPlanner/frontend.pid ]; then
            kill $(cat src/front/SportPlanner/frontend.pid) || true
          fi
          # Stop API
          if [ -f src/back/SportPlanner/SportPlanner.Api/api.pid ]; then
            kill $(cat src/back/SportPlanner/SportPlanner.Api/api.pid) || true
          fi

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'src/front/SportPlanner/e2e-results.json';
            
            if (fs.existsSync(path)) {
              const results = JSON.parse(fs.readFileSync(path, 'utf8'));
              const { stats } = results;
              
              const summary = `## üß™ E2E Test Results
              
              - **Total Tests**: ${stats.expected}
              - **Passed**: ${stats.passed} ‚úÖ
              - **Failed**: ${stats.failed} ‚ùå
              - **Skipped**: ${stats.skipped} ‚è≠Ô∏è
              - **Duration**: ${Math.round(stats.duration / 1000)}s
              
              ${stats.failed > 0 ? '‚ùå Some tests failed. Please check the artifacts for details.' : '‚úÖ All tests passed!'}
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }

  performance-regression:
    name: Performance Regression Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: test
    
    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: e2e-results-ubuntu-latest-${{ github.run_id }}
          path: ./results

      - name: Check performance regression
        run: |
          if [ -f results/e2e-results.json ]; then
            echo "Analyzing performance results..."
            # Add performance regression analysis script here
            echo "Performance analysis completed"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [test, performance-regression]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      - name: Notify on success
        if: needs.test.result == 'success'
        run: |
          echo "‚úÖ E2E tests passed on main branch"
          # Add notification logic (Slack, email, etc.)

      - name: Notify on failure
        if: needs.test.result == 'failure'
        run: |
          echo "‚ùå E2E tests failed on main branch"
          # Add notification logic (Slack, email, etc.)